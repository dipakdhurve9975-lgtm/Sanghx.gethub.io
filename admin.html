<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SANGHX â€¢ Admin Mobile</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #4F46E5;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --dark: #111827;
      --light: #F9FAFB;
      --white: #ffffff;
      --sidebar-width: 260px;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color:transparent; }
    body { background: var(--light); color: var(--dark); display: flex; min-height: 100vh; overflow-x: hidden; }

    /* --- SIDEBAR (Mobile Optimized) --- */
    .sidebar {
      width: var(--sidebar-width); background: var(--white); position: fixed; height: 100%; top: 0; left: 0;
      border-right: 1px solid #e5e7eb; padding: 20px; z-index: 1000;
      transform: translateX(0); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Overlay for mobile sidebar */
    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .sidebar-overlay.show { opacity: 1; visibility: visible; }

    .logo { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
    
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 14px 15px; /* Larger touch area */
      color: #6B7280; font-weight: 600; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 5px;
    }
    .nav-item:hover, .nav-item.active { background: #EEF2FF; color: var(--primary); }
    .nav-item i { font-size: 22px; }

    /* --- MAIN CONTENT --- */
    .main { margin-left: var(--sidebar-width); flex: 1; padding: 20px; width: calc(100% - var(--sidebar-width)); transition: 0.3s; }
    
    /* Header Mobile */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: var(--light); z-index: 90; padding: 10px 0; }
    .menu-toggle { display: none; font-size: 28px; cursor: pointer; color: var(--dark); }
    .page-title { font-size: 22px; font-weight: 800; }
    
    /* Stats Grid (Scrollable on mobile) */
    .stats-grid { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 25px; 
    }
    .stat-card { background: var(--white); padding: 16px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .stat-val { font-size: 24px; font-weight: 800; margin-top: 4px; }
    .stat-label { font-size: 11px; color: #9CA3AF; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Sections */
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* ORDER CARDS (Mobile Friendly) */
    .orders-grid { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
    .order-card { background: var(--white); border-radius: 16px; padding: 16px; border: 1px solid #f3f4f6; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    
    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #e5e7eb; }
    .cust-name { font-weight: 700; font-size: 16px; color: var(--dark); }
    .order-time { font-size: 11px; color: #9CA3AF; font-weight: 500; }
    
    .order-items { margin: 10px 0; font-size: 13px; color: #4B5563; }
    .order-item-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
    
    .order-total { display: flex; justify-content: space-between; font-weight: 800; margin-top: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; font-size: 15px; }
    
    .status-badge {
      display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-top: 5px;
    }
    .st-Pending { background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA; }
    .st-Confirmed { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
    .st-Completed { background: #ECFDF5; color: #047857; border: 1px solid #A7F3D0; }
    .st-Cancelled { background: #FEF2F2; color: #B91C1C; border: 1px solid #FECACA; }

    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
    .act-btn { padding: 10px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-accept { background: var(--primary); color: white; }
    .btn-complete { background: var(--success); color: white; }
    .btn-reject { background: #F3F4F6; color: #374151; }
    .btn-del { background: #FEF2F2; color: #DC2626; border: 1px solid #FEE2E2; }

    /* MENU ITEM (List View) */
    .menu-list-item {
      display: flex; align-items: center; background: var(--white); padding: 12px;
      border-radius: 14px; margin-bottom: 10px; gap: 12px; border: 1px solid #f3f4f6;
    }
    .menu-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; background: #f3f4f6; }
    .menu-info { flex: 1; overflow: hidden; }
    .menu-title { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .menu-sub { font-size: 11px; color: #6B7280; margin-top: 2px; }
    
    .menu-actions { display: flex; flex-direction: column; gap: 5px; }
    .btn-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center; border: none; font-size: 16px; cursor: pointer; }

    /* MODALS (Mobile Full Width) */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
      display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);
    }
    .modal-overlay.open { display: flex; }
    .modal-box { 
      background: white; width: 100%; max-width: 100%; padding: 25px 20px; 
      border-radius: 20px 20px 0 0; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 85vh; overflow-y: auto; 
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    /* Floating Add Button (Mobile) */
    .fab {
      position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
      background: var(--dark); color: white; border-radius: 16px; display: none;
      justify-content: center; align-items: center; font-size: 28px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 90; cursor: pointer; border: none;
    }

    /* Form Elements */
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 14px; background: #F9FAFB; }
    input:focus, select:focus { background: white; border-color: var(--primary); }
    .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; }
    .btn-ghost { background: transparent; color: #666; margin-top: 10px; border: 1px solid #e5e7eb; }

    /* --- MOBILE RESPONSIVE QUERIES --- */
    @media(max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 280px; }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; width: 100%; padding: 15px; }
      .menu-toggle { display: block; }
      
      .header-add-btn { display: none; } /* Hide desktop add button */
      .fab { display: flex; } /* Show mobile FAB */
      
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .stats-grid .stat-card:last-child { grid-column: 1 / -1; } /* Full width last card */
    }
  </style>
</head>
<body>

  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <div class="logo">
      <i class='bx bxs-dashboard'></i> SANGHX Admin
      <i class='bx bx-x' onclick="toggleSidebar()" style="margin-left:auto; cursor:pointer; font-size:24px; color:#999;"></i>
    </div>
    
    <div class="nav-item active" onclick="switchTab('orders')">
      <i class='bx bxs-shopping-bag'></i> Live Orders
    </div>
    <div class="nav-item" onclick="switchTab('menu')">
      <i class='bx bxs-food-menu'></i> Menu Items
    </div>
    <div class="nav-item" onclick="switchTab('stores')">
      <i class='bx bxs-store'></i> Stores & Vendors
    </div>
    
    <div class="nav-item" onclick="logout()" style="margin-top:auto; color:var(--danger); background:#FEF2F2;">
      <i class='bx bxs-log-out'></i> Logout
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div style="display:flex; align-items:center; gap:15px;">
        <i class='bx bx-menu menu-toggle' onclick="toggleSidebar()"></i>
        <div class="page-title">Dashboard</div>
      </div>
      <button class="btn-primary header-add-btn" style="width:auto; padding:10px 20px;" onclick="openAddModal()">
        + Add New
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-val" style="color:var(--warning)" id="countPending">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Revenue</div>
        <div class="stat-val" style="color:var(--success)" id="totalRevenue">â‚¹0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Items</div>
        <div class="stat-val" id="totalMenu">0</div>
      </div>
    </div>

    <div id="view-orders" class="section active">
      <div class="orders-grid" id="ordersList"></div>
    </div>

    <div id="view-menu" class="section">
      <div id="menuList"></div>
    </div>

    <div id="view-stores" class="section">
      <div id="storeList"></div>
    </div>
  </div>

  <button class="fab" onclick="openAddModal()"><i class='bx bx-plus'></i></button>

  <div class="modal-overlay" id="menuModal">
    <div class="modal-box">
      <h2 style="margin-bottom:20px;" id="modalTitle">Add Item</h2>
      <input id="foodName" placeholder="Item Name (e.g. Chicken Biryani)">
      <select id="storeSelect"><option>Select Store</option></select>
      
      <label style="font-size:12px; font-weight:700; color:#666; margin-bottom:5px; display:block;">Food Image</label>
      <input type="file" id="foodImg" style="padding:10px;">
      
      <input type="number" id="priority" placeholder="Priority (1 = Top)">
      
      <div style="background:#F3F4F6; padding:15px; border-radius:12px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <small style="font-weight:800; color:#374151;">VARIANTS</small>
          <small onclick="addVariantRow()" style="color:var(--primary); font-weight:700; cursor:pointer;">+ Add Row</small>
        </div>
        <div id="variantsWrap"></div>
      </div>

      <button class="btn-primary" onclick="saveItem()">Save Item</button>
      <button class="btn-primary btn-ghost" onclick="closeModal('menuModal')">Cancel</button>
      <div id="status" style="margin-top:15px; text-align:center; font-size:13px; font-weight:600; color:var(--primary);"></div>
    </div>
  </div>

  <div class="modal-overlay" id="storeModal">
    <div class="modal-box">
      <h2 style="margin-bottom:20px;">Manage Store</h2>
      <input id="stName" placeholder="Store Name">
      <div style="display:flex; gap:10px;">
        <input id="stOpen" placeholder="Open (10 AM)">
        <input id="stClose" placeholder="Close (10 PM)">
      </div>
      <input type="number" id="stPrio" placeholder="Priority Order">
      <button class="btn-primary" onclick="saveStore()">Save Store</button>
      <button class="btn-primary btn-ghost" onclick="closeModal('storeModal')">Cancel</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const app = initializeApp({ apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM", projectId: "sanghx-foods" });
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, u => { if(!u) location.href="login.html"; });

  let currentTab = 'orders';
  let editingId = null;
  let editingOldImg = null;

  // --- MOBILE SIDEBAR ---
  window.toggleSidebar = () => {
    document.getElementById('sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay').classList.toggle('show');
  }

  window.switchTab = (tab) => {
    currentTab = tab;
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    document.getElementById(`view-${tab}`).classList.add('active');
    const idx = ['orders', 'menu', 'stores'].indexOf(tab);
    document.querySelectorAll('.nav-item')[idx].classList.add('active');
    
    document.querySelector('.page-title').innerText = tab === 'orders' ? 'Live Orders' : (tab === 'menu' ? 'Menu' : 'Stores');
    
    // Auto close sidebar on mobile click
    if(window.innerWidth < 768) toggleSidebar();
  }

  // --- ORDERS ---
  const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
  onSnapshot(q, (snapshot) => {
    const list = document.getElementById("ordersList");
    list.innerHTML = "";
    let pendingCount = 0, revenue = 0;

    if(snapshot.empty) { list.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>No Orders Yet</div>"; return; }

    snapshot.forEach(docSnap => {
      const order = docSnap.data();
      const oid = docSnap.id;
      if(order.status === "Pending") pendingCount++;
      if(order.status === "Completed") revenue += (order.bill?.total || 0);

      const itemsHtml = order.items.map(i => `
        <div class="order-item-row">
          <span>${i.qty}x ${i.name}</span>
          <span>â‚¹${i.price * i.qty}</span>
        </div>
      `).join("");

      let btns = "";
      if(order.status === "Pending") {
        btns = `<button class="act-btn btn-accept" onclick="updateStatus('${oid}','Confirmed')">Accept</button>
                <button class="act-btn btn-del" onclick="updateStatus('${oid}','Cancelled')">Reject</button>`;
      } else if(order.status === "Confirmed") {
        btns = `<button class="act-btn btn-complete" style="grid-column:1/-1" onclick="updateStatus('${oid}','Completed')">Mark Delivered</button>`;
      }

      list.innerHTML += `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="cust-name">${order.customer.name}</div>
              <div class="order-time">${new Date(order.timestamp?.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
            </div>
            <a href="${order.customer.location}" target="_blank" style="background:#EEF2FF; width:36px; height:36px; display:flex; justify-content:center; align-items:center; border-radius:50%; color:var(--primary);"><i class='bx bxs-map'></i></a>
          </div>
          <div style="font-size:12px; margin-bottom:10px; color:#666;">
             ðŸ“ž <a href="tel:${order.customer.mobile}">${order.customer.mobile}</a> â€¢ ${order.customer.address}
          </div>
          <div class="order-items">${itemsHtml}</div>
          <div class="order-total">
            <span>Total (${order.payment})</span>
            <span>â‚¹${order.bill?.total}</span>
          </div>
          <div style="text-align:right;"><span class="status-badge st-${order.status}">${order.status}</span></div>
          <div class="action-btns">${btns}</div>
        </div>`;
    });
    document.getElementById("countPending").innerText = pendingCount;
    document.getElementById("totalRevenue").innerText = "â‚¹" + revenue;
  });

  window.updateStatus = async (id, st) => { if(confirm(`Mark ${st}?`)) await updateDoc(doc(db,"orders",id), {status:st}); }

  // --- MENU ---
  onSnapshot(collection(db, "menu"), snap => {
    const list = document.getElementById("menuList");
    list.innerHTML = "";
    document.getElementById("totalMenu").innerText = snap.size;
    const items = [];
    snap.forEach(d => items.push({id:d.id, ...d.data()}));
    
    items.forEach(i => {
      list.innerHTML += `
        <div class="menu-list-item">
          <img src="${i.img}" class="menu-img">
          <div class="menu-info">
            <div class="menu-title">${i.name}</div>
            <div class="menu-sub">${i.storeName} â€¢ â‚¹${i.variants?.[0]?.price}</div>
          </div>
          <div class="menu-actions">
            <button class="btn-icon" style="background:#F3F4F6;" onclick='editMenu("${i.id}", ${JSON.stringify(i).replace(/'/g,"")})'><i class='bx bxs-edit'></i></button>
            <button class="btn-icon" style="background:#FEE2E2; color:red;" onclick="deleteMenu('${i.id}')"><i class='bx bxs-trash'></i></button>
          </div>
        </div>`;
    });
  });

  // --- STORES ---
  onSnapshot(collection(db, "stores"), snap => {
    const list = document.getElementById("storeList");
    const select = document.getElementById("storeSelect");
    list.innerHTML = ""; select.innerHTML = "<option value=''>Select Store</option>";
    
    snap.forEach(doc => {
      const s = doc.data(); s.id = doc.id;
      select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
      list.innerHTML += `
        <div class="menu-list-item">
          <div class="menu-info">
            <div class="menu-title">${s.name}</div>
            <div class="menu-sub">${s.openTime} - ${s.closeTime}</div>
            <span class="status-badge ${s.isOnline?'st-Completed':'st-Cancelled'}">${s.isOnline?'Online':'Offline'}</span>
          </div>
          <div class="menu-actions">
            <button class="btn-icon" style="background:${s.isOnline?'#D1FAE5':'#F3F4F6'}" onclick="toggleStore('${s.id}',${s.isOnline})"><i class='bx bx-power-off'></i></button>
            <button class="btn-icon" onclick='editStore("${s.id}", ${JSON.stringify(s).replace(/'/g,"")})'><i class='bx bxs-edit'></i></button>
          </div>
        </div>`;
    });
  });

  // --- MODALS & CRUD ---
  window.openAddModal = () => {
    if(currentTab === 'menu') {
        editingId = null;
        document.getElementById('modalTitle').innerText = "Add New Item";
        document.getElementById('foodName').value = "";
        document.getElementById('variantsWrap').innerHTML = "";
        addVariantRow();
        document.getElementById('menuModal').classList.add('open');
    } else if (currentTab === 'stores') {
        editingId = null;
        document.getElementById('stName').value = "";
        document.getElementById('storeModal').classList.add('open');
    } else {
        alert("Switch to Menu or Store tab first!");
    }
  }

  window.closeModal = (id) => document.getElementById(id).classList.remove('open');
  
  window.addVariantRow = (l="", p="") => {
    const d = document.createElement("div"); d.style.cssText = "display:flex; gap:8px; margin-bottom:8px;";
    d.innerHTML = `<input placeholder="Label (e.g. Half)" value="${l}" style="margin:0; flex:1;"><input type="number" placeholder="â‚¹" value="${p}" style="margin:0; width:80px;"><i class='bx bxs-trash' onclick="this.parentElement.remove()" style="font-size:20px; color:red; margin-top:12px;"></i>`;
    document.getElementById("variantsWrap").appendChild(d);
  }

  window.saveItem = async () => {
    const name = document.getElementById("foodName").value;
    const store = document.getElementById("storeSelect").value;
    const prio = Number(document.getElementById("priority").value);
    const file = document.getElementById("foodImg").files[0];
    
    const variants = [];
    document.querySelectorAll("#variantsWrap div").forEach(r => {
        const i = r.querySelectorAll("input");
        if(i[0].value && i[1].value) variants.push({ label: i[0].value, price: Number(i[1].value) });
    });

    if(!name || variants.length === 0) return alert("Details missing");
    document.getElementById("status").innerText = "Uploading Image...";

    let imgUrl = editingOldImg;
    if(file) {
        const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", "SANGHX");
        const res = await fetch(`https://api.cloudinary.com/v1_1/dvbaqh8ja/image/upload`, { method:"POST", body:fd });
        const data = await res.json();
        imgUrl = data.secure_url;
    }

    const payload = { name, storeName: store, priority: prio, variants, img: imgUrl || "" };
    if(editingId) await updateDoc(doc(db,"menu",editingId), payload);
    else await addDoc(collection(db,"menu"), payload);

    document.getElementById("status").innerText = "";
    closeModal('menuModal');
  };

  window.saveStore = async () => {
    const name = document.getElementById("stName").value;
    const open = document.getElementById("stOpen").value;
    const close = document.getElementById("stClose").value;
    const prio = Number(document.getElementById("stPrio").value);
    
    if(editingId) await updateDoc(doc(db,"stores",editingId), { name, openTime:open, closeTime:close, priority:prio });
    else await addDoc(collection(db,"stores"), { name, openTime:open, closeTime:close, priority:prio, isOnline:true });
    
    closeModal('storeModal');
  };

  window.toggleStore = async (id, status) => await updateDoc(doc(db,"stores",id), { isOnline: !status });
  
  window.editMenu = (id, i) => {
    editingId = id; editingOldImg = i.img;
    document.getElementById('modalTitle').innerText = "Edit Item";
    document.getElementById('foodName').value = i.name;
    document.getElementById('storeSelect').value = i.storeName;
    document.getElementById('priority').value = i.priority;
    document.getElementById('variantsWrap').innerHTML = "";
    i.variants.forEach(v => addVariantRow(v.label, v.price));
    document.getElementById('menuModal').classList.add('open');
  };

  window.editStore = (id, s) => {
    editingId = id;
    document.getElementById('stName').value = s.name;
    document.getElementById('stOpen').value = s.openTime;
    document.getElementById('stClose').value = s.closeTime;
    document.getElementById('stPrio').value = s.priority;
    document.getElementById('storeModal').classList.add('open');
  };

  window.deleteMenu = async (id) => { if(confirm("Delete Item?")) await deleteDoc(doc(db,"menu",id)); };
  window.deleteStore = async (id) => { if(confirm("Delete Store?")) await deleteDoc(doc(db,"stores",id)); };
  window.logout = () => signOut(auth).then(()=>location.href="login.html");

</script>
</body>
</html>
