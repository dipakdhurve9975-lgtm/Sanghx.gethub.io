<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SANGHX • Admin Dashboard</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #4F46E5;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --dark: #111827;
      --light: #F3F4F6;
      --white: #ffffff;
      --sidebar-width: 250px;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans', sans-serif; }
    body { background: var(--light); color: var(--dark); display: flex; min-height: 100vh; }

    /* --- SIDEBAR --- */
    .sidebar {
      width: var(--sidebar-width); background: var(--white); position: fixed; height: 100%;
      border-right: 1px solid #e5e7eb; padding: 20px; z-index: 100;
      transition: 0.3s;
    }
    .logo { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
    
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 15px;
      color: #6B7280; font-weight: 600; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 5px;
    }
    .nav-item:hover, .nav-item.active { background: #EEF2FF; color: var(--primary); }
    .nav-item i { font-size: 20px; }

    /* --- MAIN CONTENT --- */
    .main { margin-left: var(--sidebar-width); flex: 1; padding: 30px; width: calc(100% - var(--sidebar-width)); }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .page-title { font-size: 24px; font-weight: 800; }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: var(--white); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .stat-val { font-size: 28px; font-weight: 800; margin-top: 5px; }
    .stat-label { font-size: 13px; color: #6B7280; font-weight: 600; text-transform: uppercase; }

    /* Sections */
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* ORDER CARDS */
    .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .order-card { background: var(--white); border-radius: 16px; padding: 20px; border: 1px solid #e5e7eb; position: relative; }
    .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
    .cust-name { font-weight: 700; font-size: 16px; }
    .order-time { font-size: 12px; color: #9CA3AF; }
    
    .order-items { margin: 10px 0; font-size: 14px; color: #4B5563; }
    .order-item-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    
    .order-total { display: flex; justify-content: space-between; font-weight: 700; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; font-size: 16px; }
    
    .status-badge {
      display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-top: 10px;
    }
    .st-Pending { background: #FEF3C7; color: #D97706; }
    .st-Confirmed { background: #DBEAFE; color: #2563EB; }
    .st-Completed { background: #D1FAE5; color: #059669; }
    .st-Cancelled { background: #FEE2E2; color: #DC2626; }

    .action-btns { display: flex; gap: 10px; margin-top: 15px; }
    .act-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-accept { background: var(--primary); color: white; }
    .btn-complete { background: var(--success); color: white; }
    .btn-reject { background: #f3f4f6; color: var(--dark); }
    .btn-del { background: #FEE2E2; color: #DC2626; }

    /* MENU & STORE LIST */
    .menu-list-item {
      display: flex; align-items: center; background: var(--white); padding: 15px;
      border-radius: 12px; margin-bottom: 10px; gap: 15px; border: 1px solid #f3f4f6;
    }
    .menu-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; }
    .menu-info { flex: 1; }
    
    /* MODALS */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
    }
    .modal-overlay.open { display: flex; }
    .modal-box { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px; animation: popUp 0.3s; }
    @keyframes popUp { from{transform:scale(0.9)} to{transform:scale(1)} }

    /* Form Elements */
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; }
    .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn-ghost { background: transparent; color: #666; margin-top: 10px; }

    /* Mobile */
    @media(max-width: 768px){
      .sidebar { transform: translateX(-100%); }
      .sidebar.show { transform: translateX(0); }
      .main { margin-left: 0; width: 100%; }
      .menu-btn { display: block; font-size: 24px; cursor: pointer; }
    }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar">
    <div class="logo"><i class='bx bxs-dashboard'></i> SANGHX Admin</div>
    
    <div class="nav-item active" onclick="switchTab('orders')">
      <i class='bx bxs-shopping-bag'></i> Live Orders
    </div>
    <div class="nav-item" onclick="switchTab('menu')">
      <i class='bx bxs-food-menu'></i> Menu Items
    </div>
    <div class="nav-item" onclick="switchTab('stores')">
      <i class='bx bxs-store'></i> Stores & Vendors
    </div>
    
    <div class="nav-item" onclick="logout()" style="margin-top:auto; color:var(--danger);">
      <i class='bx bxs-log-out'></i> Logout
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div style="display:flex; align-items:center; gap:10px;">
        <i class='bx bx-menu menu-btn' onclick="toggleSidebar()" style="display:none;"></i>
        <div class="page-title">Dashboard</div>
      </div>
      <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="openAddModal()">
        + Add New
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Pending Orders</div>
        <div class="stat-val" style="color:var(--warning)" id="countPending">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today's Revenue</div>
        <div class="stat-val" style="color:var(--success)" id="totalRevenue">₹0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Menu Items</div>
        <div class="stat-val" id="totalMenu">0</div>
      </div>
    </div>

    <div id="view-orders" class="section active">
      <div class="orders-grid" id="ordersList"></div>
    </div>

    <div id="view-menu" class="section">
      <div id="menuList"></div>
    </div>

    <div id="view-stores" class="section">
      <div id="storeList"></div>
    </div>
  </div>

  <div class="modal-overlay" id="menuModal">
    <div class="modal-box">
      <h2 style="margin-bottom:15px;" id="modalTitle">Add Item</h2>
      <input id="foodName" placeholder="Item Name">
      <select id="storeSelect"><option>Select Store</option></select>
      <input type="file" id="foodImg">
      <input type="number" id="priority" placeholder="Priority (1=Top)">
      
      <div style="background:#f9fafb; padding:10px; border-radius:10px; margin-bottom:10px;">
        <small style="font-weight:700; color:#aaa;">VARIANTS (Qty - Price)</small>
        <div id="variantsWrap"></div>
        <button onclick="addVariantRow()" style="background:black; color:white; padding:5px 10px; border:none; border-radius:6px; font-size:12px; margin-top:5px;">+ Variant</button>
      </div>

      <button class="btn-primary" onclick="saveItem()">Save Item</button>
      <button class="btn-primary btn-ghost" onclick="closeModal('menuModal')">Cancel</button>
      <div id="status" style="margin-top:10px; text-align:center; font-size:12px;"></div>
    </div>
  </div>

  <div class="modal-overlay" id="storeModal">
    <div class="modal-box">
      <h2 style="margin-bottom:15px;">Manage Store</h2>
      <input id="stName" placeholder="Store Name">
      <div style="display:flex; gap:10px;">
        <input id="stOpen" placeholder="Open (10 AM)">
        <input id="stClose" placeholder="Close (10 PM)">
      </div>
      <input type="number" id="stPrio" placeholder="Priority">
      <button class="btn-primary" onclick="saveStore()">Save Store</button>
      <button class="btn-primary btn-ghost" onclick="closeModal('storeModal')">Cancel</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const app = initializeApp({ apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM", projectId: "sanghx-foods" });
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, u => { if(!u) location.href="login.html"; });

  let currentTab = 'orders';
  let editingId = null;
  let editingOldImg = null;

  // --- TAB NAVIGATION ---
  window.switchTab = (tab) => {
    currentTab = tab;
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    document.getElementById(`view-${tab}`).classList.add('active');
    const idx = ['orders', 'menu', 'stores'].indexOf(tab);
    document.querySelectorAll('.nav-item')[idx].classList.add('active');
    
    document.querySelector('.page-title').innerText = tab === 'orders' ? 'Live Orders' : (tab === 'menu' ? 'Menu Management' : 'Stores');
  }

  // --- ORDERS LOGIC ---
  const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
  
  onSnapshot(q, (snapshot) => {
    const list = document.getElementById("ordersList");
    list.innerHTML = "";
    
    let pendingCount = 0;
    let revenue = 0;

    if(snapshot.empty) {
      list.innerHTML = "<div style='text-align:center; grid-column:1/-1; padding:40px; opacity:0.5;'>No Orders Yet</div>";
      return;
    }

    snapshot.forEach(docSnap => {
      const order = docSnap.data();
      const oid = docSnap.id;
      
      if(order.status === "Pending") pendingCount++;
      if(order.status === "Completed") revenue += (order.bill?.total || 0);

      const statusClass = `st-${order.status || 'Pending'}`;
      const itemsHtml = order.items.map(i => `
        <div class="order-item-row">
          <span>${i.qty}x ${i.name} <small>(${i.variantLabel})</small></span>
          <span>₹${i.price * i.qty}</span>
        </div>
      `).join("");

      let buttonsHtml = "";
      if(order.status === "Pending") {
        buttonsHtml = `
          <button class="act-btn btn-accept" onclick="updateOrderStatus('${oid}', 'Confirmed')">Confirm Order</button>
          <button class="act-btn btn-del" onclick="updateOrderStatus('${oid}', 'Cancelled')">Reject</button>
        `;
      } else if(order.status === "Confirmed") {
        buttonsHtml = `
          <button class="act-btn btn-complete" onclick="updateOrderStatus('${oid}', 'Completed')">Mark Delivered</button>
        `;
      }

      list.innerHTML += `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="cust-name">${order.customer.name}</div>
              <div class="order-time">${new Date(order.timestamp?.toDate()).toLocaleTimeString()}</div>
            </div>
            <a href="${order.customer.location}" target="_blank" style="color:var(--primary); font-size:24px;"><i class='bx bxs-map'></i></a>
          </div>
          
          <div style="font-size:13px; margin-bottom:10px;">
            <i class='bx bxs-phone'></i> <a href="tel:${order.customer.mobile}">${order.customer.mobile}</a><br>
            <i class='bx bxs-home'></i> ${order.customer.address}
          </div>

          <div class="order-items">${itemsHtml}</div>
          
          <div class="order-total">
            <span>Total Bill (${order.payment})</span>
            <span>₹${order.bill?.total}</span>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="status-badge ${statusClass}">${order.status}</div>
          </div>

          <div class="action-btns">${buttonsHtml}</div>
        </div>
      `;
    });

    document.getElementById("countPending").innerText = pendingCount;
    document.getElementById("totalRevenue").innerText = "₹" + revenue;
  });

  window.updateOrderStatus = async (id, status) => {
    if(!confirm(`Mark this order as ${status}?`)) return;
    await updateDoc(doc(db, "orders", id), { status: status });
  }

  // --- MENU LOGIC ---
  onSnapshot(collection(db, "menu"), snap => {
    const list = document.getElementById("menuList");
    list.innerHTML = "";
    document.getElementById("totalMenu").innerText = snap.size;
    
    const items = [];
    snap.forEach(d => items.push({id:d.id, ...d.data()}));
    items.sort((a,b)=> (a.priority||99)-(b.priority||99));

    items.forEach(i => {
      list.innerHTML += `
        <div class="menu-list-item">
          <img src="${i.img}" class="menu-img">
          <div class="menu-info">
            <div style="font-weight:700;">${i.name}</div>
            <div style="font-size:12px; color:#666;">${i.storeName} • ₹${i.variants?.[0]?.price}</div>
          </div>
          <button class="act-btn btn-reject" onclick='editMenu("${i.id}", ${JSON.stringify(i).replace(/'/g,"")})'><i class='bx bxs-edit'></i></button>
          <button class="act-btn btn-del" style="color:red;" onclick="deleteMenu('${i.id}')"><i class='bx bxs-trash'></i></button>
        </div>`;
    });
  });

  // --- STORE LOGIC ---
  onSnapshot(collection(db, "stores"), snap => {
    const list = document.getElementById("storeList");
    const select = document.getElementById("storeSelect");
    list.innerHTML = ""; select.innerHTML = "<option value=''>Select Store</option>";
    
    const stores = [];
    snap.forEach(d => stores.push({id:d.id, ...d.data()}));
    
    stores.forEach(s => {
      select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
      list.innerHTML += `
        <div class="menu-list-item">
          <div class="menu-info">
            <div style="font-weight:700;">${s.name}</div>
            <div style="font-size:12px; color:#666;">${s.openTime} - ${s.closeTime}</div>
          </div>
          <button class="act-btn ${s.isOnline?'btn-complete':'btn-reject'}" onclick="toggleStore('${s.id}',${s.isOnline})">
            ${s.isOnline?'Online':'Offline'}
          </button>
          <button class="act-btn btn-reject" onclick='editStore("${s.id}", ${JSON.stringify(s).replace(/'/g,"")})'><i class='bx bxs-edit'></i></button>
          <button class="act-btn btn-del" onclick="deleteStore('${s.id}')"><i class='bx bxs-trash'></i></button>
        </div>`;
    });
  });

  // --- CRUD HELPERS ---
  window.openAddModal = () => {
    if(currentTab === 'menu') {
        editingId = null;
        document.getElementById('modalTitle').innerText = "Add New Item";
        document.getElementById('foodName').value = "";
        document.getElementById('variantsWrap').innerHTML = "";
        addVariantRow();
        document.getElementById('menuModal').classList.add('open');
    } else if (currentTab === 'stores') {
        editingId = null;
        document.getElementById('stName').value = "";
        document.getElementById('storeModal').classList.add('open');
    }
  }

  window.closeModal = (id) => document.getElementById(id).classList.remove('open');
  
  window.addVariantRow = (l="", p="") => {
    const d = document.createElement("div"); d.style.cssText = "display:flex; gap:5px; margin-bottom:5px;";
    d.innerHTML = `<input placeholder="Label (e.g. Half)" value="${l}" style="margin:0"><input type="number" placeholder="Price" value="${p}" style="margin:0"><span onclick="this.parentElement.remove()" style="cursor:pointer; color:red;">x</span>`;
    document.getElementById("variantsWrap").appendChild(d);
  }

  // --- SAVING DATA ---
  window.saveItem = async () => {
    const name = document.getElementById("foodName").value;
    const store = document.getElementById("storeSelect").value;
    const prio = Number(document.getElementById("priority").value);
    const file = document.getElementById("foodImg").files[0];
    
    const variants = [];
    document.querySelectorAll("#variantsWrap div").forEach(r => {
        const i = r.querySelectorAll("input");
        if(i[0].value && i[1].value) variants.push({ label: i[0].value, price: Number(i[1].value) });
    });

    if(!name || variants.length === 0) return alert("Details missing");
    document.getElementById("status").innerText = "Uploading...";

    let imgUrl = editingOldImg;
    if(file) {
        const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", "SANGHX");
        const res = await fetch(`https://api.cloudinary.com/v1_1/dvbaqh8ja/image/upload`, { method:"POST", body:fd });
        const data = await res.json();
        imgUrl = data.secure_url;
    }

    const payload = { name, storeName: store, priority: prio, variants, img: imgUrl || "" };
    if(editingId) await updateDoc(doc(db,"menu",editingId), payload);
    else await addDoc(collection(db,"menu"), payload);

    document.getElementById("status").innerText = "";
    closeModal('menuModal');
  };

  window.saveStore = async () => {
    const name = document.getElementById("stName").value;
    const open = document.getElementById("stOpen").value;
    const close = document.getElementById("stClose").value;
    const prio = Number(document.getElementById("stPrio").value);
    
    if(editingId) await updateDoc(doc(db,"stores",editingId), { name, openTime:open, closeTime:close, priority:prio });
    else await addDoc(collection(db,"stores"), { name, openTime:open, closeTime:close, priority:prio, isOnline:true });
    
    closeModal('storeModal');
  };

  window.toggleStore = async (id, status) => await updateDoc(doc(db,"stores",id), { isOnline: !status });
  
  window.editMenu = (id, i) => {
    editingId = id; editingOldImg = i.img;
    document.getElementById('modalTitle').innerText = "Edit Item";
    document.getElementById('foodName').value = i.name;
    document.getElementById('storeSelect').value = i.storeName;
    document.getElementById('priority').value = i.priority;
    document.getElementById('variantsWrap').innerHTML = "";
    i.variants.forEach(v => addVariantRow(v.label, v.price));
    document.getElementById('menuModal').classList.add('open');
  };

  window.editStore = (id, s) => {
    editingId = id;
    document.getElementById('stName').value = s.name;
    document.getElementById('stOpen').value = s.openTime;
    document.getElementById('stClose').value = s.closeTime;
    document.getElementById('stPrio').value = s.priority;
    document.getElementById('storeModal').classList.add('open');
  };

  window.deleteMenu = async (id) => { if(confirm("Delete Item?")) await deleteDoc(doc(db,"menu",id)); };
  window.deleteStore = async (id) => { if(confirm("Delete Store? This will remove it from the customer app.")) await deleteDoc(doc(db,"stores",id)); };
  
  window.logout = () => signOut(auth).then(()=>location.href="login.html");
  
  // Mobile Sidebar
  window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('show');

</script>
</body>
</html>
