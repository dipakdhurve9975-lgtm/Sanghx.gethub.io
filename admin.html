<!DOCTYPE html>
<html>
<head>
  <title>SANGHX Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:Arial;background:#f4f4f4;margin:0}
    .header{background:black;color:white;padding:15px;text-align:center;font-weight:bold}
    .container{padding:15px}
    .card{background:white;padding:15px;border-radius:12px;margin-bottom:15px}
    input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
    button{background:#e23744;color:white;border:none;font-weight:bold;cursor:pointer}
    img{width:100%;border-radius:10px;margin-top:5px}
    .small{font-size:12px;opacity:0.7}
  </style>
</head>
<body>

<script>
  const password = "admin123";
  const entered = prompt("Enter Admin Password:");
  if(entered !== password){
    alert("Wrong password");
    document.body.innerHTML = "";
  }
</script>

<div class="header">üõ† SANGHX Admin</div>

<div class="container">

  <div class="card">
    <h3>Add Menu Item</h3>

    <input id="name" placeholder="Food name">
    <input id="price" placeholder="Price" type="number">
    <input type="file" id="img">

    <select id="storeName" required>
      <option value="">Select Store</option>
      <option value="makhan Foods">Makhan Foods</option>
      <option value="Ab Foods">AB Foods</option>
      <option value="AS FOODS">AS Foods</option>
    </select>

    <button onclick="addMenu()">Add</button>
    <p class="small" id="uploadStatus"></p>
  </div>

  <div class="card">
    <h3>Current Menu</h3>
    <div id="menuList"></div>
  </div>

  <div class="card">
    <h3>Orders</h3>
    <div id="orders"></div>
  </div>

</div>

<script type="module" src="firebase.js">
  // -------------------------
  // SETTINGS
  // -------------------------
  const CLOUD_NAME = "dvbaqh8ja";
  const UPLOAD_PRESET = "SANGHX";

  // -------------------------
  // DATA
  // -------------------------
  let menu = JSON.parse(localStorage.getItem("menu")) || [];
  let orders = JSON.parse(localStorage.getItem("orders")) || [];

  const menuList = document.getElementById("menuList");
  const ordersDiv = document.getElementById("orders");
  const uploadStatus = document.getElementById("uploadStatus");

  // -------------------------
  // ADD MENU (Cloudinary Upload)
  // -------------------------
  async function addMenu(){
    const name = document.getElementById("name").value.trim();
    const price = document.getElementById("price").value.trim();
    const storeName = document.getElementById("storeName").value;
    const file = document.getElementById("img").files[0];

    if(!name || !price || !storeName || !file){
      alert("Fill all fields");
      return;
    }

    uploadStatus.innerText = "‚è≥ Uploading image...";

    // Cloudinary Upload
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      console.log("Cloudinary Response:", data);

      if (data.error) {
        uploadStatus.innerText = "";
        alert("Cloudinary Error: " + data.error.message);
        return;
      }

      // ‚úÖ FIXED CONDITION
      if (!data.secure_url) {
        uploadStatus.innerText = "";
        alert("Upload failed, no secure_url received");
        return;
      }

      const imageUrl = data.secure_url;

      // Save in localStorage
      menu.push({
        name,
        price: Number(price),
        storeName,
        img: imageUrl
      });

      localStorage.setItem("menu", JSON.stringify(menu));
      renderMenu();

      // clear inputs
      document.getElementById("name").value = "";
      document.getElementById("price").value = "";
      document.getElementById("img").value = "";
      document.getElementById("storeName").value = "";

      uploadStatus.innerText = "‚úÖ Image uploaded & item added!";
      alert("‚úÖ Item Added Successfully!");

    } catch (err) {
      console.log(err);
      uploadStatus.innerText = "";
      alert("‚ùå Upload error (check internet or preset settings)");
    }
  }

  // -------------------------
  // RENDER MENU
  // -------------------------
  function renderMenu(){
    menuList.innerHTML = "";

    if(menu.length === 0){
      menuList.innerHTML = "<p class='small'>No items added yet</p>";
      return;
    }

    menu.forEach((item, index)=>{
      menuList.innerHTML += `
        <div style="border:1px solid #ddd;padding:10px;margin:10px 0;border-radius:10px;background:#fff">
          <img src="${item.img}">
          <h4>${item.name}</h4>
          <p>‚Çπ${item.price}</p>
          <small>Store: ${item.storeName}</small><br><br>
          <button onclick="deleteMenu(${index})" style="background:black;">Delete</button>
        </div>
      `;
    });
  }

  function deleteMenu(index){
    if(confirm("Delete this item?")){
      menu.splice(index, 1);
      localStorage.setItem("menu", JSON.stringify(menu));
      renderMenu();
    }
  }

  // -------------------------
  // RENDER ORDERS
  // -------------------------
  function renderOrders(){
    ordersDiv.innerHTML = "";

    if(orders.length === 0){
      ordersDiv.innerHTML = "<p class='small'>No orders yet</p>";
      return;
    }

    orders.forEach((o)=>{
      let itemsHtml = "";

      // if items saved as array
      if(Array.isArray(o.items)){
        itemsHtml = o.items.map(i => `‚Ä¢ ${i.name} x${i.qty} (${i.storeName})`).join("<br>");
      } else {
        // fallback old format
        itemsHtml = o.items || "";
      }

      ordersDiv.innerHTML += `
        <div style="border:1px solid #ddd;padding:12px;margin:10px 0;border-radius:10px;background:#fff">
          <b>üë§ Name:</b> ${o.customerName || "-"}<br>
          <b>üìû Mobile:</b> ${o.customerMobile || "-"}<br>
          <b>üè† Address:</b> ${o.customerAddress || "-"}<br>
          <b>üí≥ Payment:</b> ${o.paymentMode || "-"}<br>
          <b>üìç Location:</b> ${
            o.location ? `<a href="${o.location}" target="_blank">Open Map</a>` : "-"
          }<br><br>

          <b>üì¶ Items:</b><br>${itemsHtml}<br><br>
          <b>üí∞ Total:</b> ‚Çπ${o.total || 0}<br>
          <b>Status:</b> ${o.status || "New"}<br>
          <small>${o.time || ""}</small>
        </div>
      `;
    });
  }

  // -------------------------
  // AUTO UPDATE
  // -------------------------
  renderMenu();
  renderOrders();

  window.addEventListener("storage", ()=>{
    menu = JSON.parse(localStorage.getItem("menu")) || [];
    orders = JSON.parse(localStorage.getItem("orders")) || [];
    renderMenu();
    renderOrders();
  });
</script>

</body>
</html>

