<!DOCTYPE html>
<html>
<head>
  <title>SANGHX Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:#fff7f5;padding:16px;}

    .card{
      max-width:600px;
      margin:auto;
      background:white;
      padding:18px;
      border-radius:18px;
      box-shadow:0 10px 25px rgba(0,0,0,0.08);
    }

    h2{
      text-align:center;
      background:linear-gradient(135deg,#e23744,#ff5a5f);
      color:white;
      padding:14px;
      border-radius:14px;
      margin-bottom:16px;
      font-size:20px;
    }

    h3{margin-top:14px;font-size:16px}

    input, select{
      width:100%;
      padding:12px;
      margin:10px 0;
      border-radius:12px;
      border:1px solid #ddd;
      outline:none;
      font-size:14px;
    }

    button{
      width:100%;
      padding:12px;
      border:none;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      font-size:15px;
      transition:0.2s;
    }
    button:active{transform:scale(0.98);}

    .btn-orange{background:linear-gradient(135deg,#ff7a18,#ff9f45);color:white;}
    .btn-green{background:linear-gradient(135deg,#25D366,#1ebe5d);color:white;}
    .btn-black{background:#111;color:white;}
    .btn-red{background:#ff3b3b;color:white;}
    .btn-grey{background:#f2f2f2;color:#111;}

    .status{
      margin-top:10px;
      font-size:13px;
      opacity:0.85;
      min-height:18px;
    }

    .section{
      margin-top:14px;
      padding:14px;
      border:1px solid #eee;
      border-radius:16px;
      background:#fffaf9;
    }

    .row{display:flex;gap:10px;}
    .row > *{flex:1;}

    .listTitle{
      margin-top:18px;
      font-size:18px;
      font-weight:800;
    }

    .storeCard, .menu-item{
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
      border:1px solid #eee;
      padding:10px;
      margin-top:10px;
      border-radius:14px;
    }

    .storeInfo, .menu-info{
      flex:1;
      min-width:0;
    }

    .storeInfo b, .menu-info b{
      font-size:14px;
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .storeInfo small, .menu-info small{
      opacity:0.75;
      font-size:12px;
      display:block;
      margin-top:2px;
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .smallBtn{
      width:auto;
      padding:8px 12px;
      border-radius:12px;
      font-size:13px;
      font-weight:800;
    }

    .menu-item img{
      width:62px;height:62px;border-radius:12px;object-fit:cover;background:#f0f0f0;
    }

    .variantsBox{
      margin-top:6px;
      padding:12px;
      border:1px dashed #ddd;
      border-radius:14px;
      background:#fff;
    }

    .variantRow{
      display:flex;
      gap:8px;
      margin-top:8px;
      align-items:center;
    }
    .variantRow input{
      margin:0;
      padding:10px;
      border-radius:12px;
      border:1px solid #ddd;
      outline:none;
      font-size:13px;
    }
    .variantRow button{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      background:#ff3b3b;
      color:white;
      font-weight:900;
      font-size:13px;
    }

    .hint{
      font-size:12px;
      opacity:0.75;
      margin-top:6px;
      line-height:1.4;
    }

    .modeTag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      background:#111;
      color:white;
      margin-bottom:10px;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>‚öôÔ∏è SANGHX Admin</h2>

    <!-- STORES -->
    <div class="section">
      <h3>üè™ Stores / Vendors</h3>

      <input id="storeNewName" placeholder="Store Name (e.g. HOTEL NAGZIRA)">

      <div class="row">
        <input id="storeOrder" type="number" placeholder="Order (1=top)" min="1">
        <select id="storeOnline">
          <option value="true">üü¢ Online</option>
          <option value="false">üî¥ Offline</option>
        </select>
      </div>

      <div class="row">
        <input id="openTime" type="time" value="10:00">
        <input id="closeTime" type="time" value="22:30">
      </div>

      <button class="btn-orange" onclick="addStore()">+ Add Store</button>
      <div class="status" id="storeStatus"></div>

      <div class="listTitle">Current Stores</div>
      <div id="storeList"></div>
    </div>

    <!-- CATEGORIES -->
    <div class="section">
      <h3>üè∑Ô∏è Categories</h3>

      <input id="newCategory" placeholder="Add category (e.g. Biryani / Snacks / Sweet)">
      <button class="btn-black" onclick="addCategory()">+ Add Category</button>

      <div class="status" id="catStatus"></div>
      <div class="listTitle">Current Categories</div>
      <div id="catList"></div>
    </div>

    <!-- MENU -->
    <div class="section">
      <div class="modeTag" id="modeTag">ADD MODE</div>

      <h3 id="formTitle">üçΩ Add Menu Item</h3>

      <input type="text" id="foodName" placeholder="Food Name (e.g. Jalebi)">
      <input type="file" id="foodImg" accept="image/*">

      <div class="row">
        <select id="storeSelect">
          <option value="">Loading stores...</option>
        </select>
        <input type="number" id="priority" placeholder="Priority (1 = top)" min="1">
      </div>

      <select id="categorySelect">
        <option value="">Loading categories...</option>
      </select>

      <div class="variantsBox">
        <b>Quantity / Variants</b>
        <div class="hint">Example: 1 Pav ‚Çπ60, Half KG ‚Çπ180, Full KG ‚Çπ350</div>

        <div id="variantsWrap"></div>
        <button class="btn-black" onclick="addVariantRow()">+ Add Variant</button>
      </div>

      <button class="btn-orange" id="addBtn" onclick="addMenuItem()">Add Item</button>
      <button class="btn-green" id="saveBtn" onclick="saveEdit()" style="display:none;">Save Changes</button>
      <button class="btn-grey" id="cancelBtn" onclick="cancelEdit()" style="display:none;">Cancel Edit</button>

      <div class="status" id="statusText"></div>

      <div class="listTitle">Current Menu</div>
      <div id="menuList"></div>

      <button class="btn-black" onclick="logout()">Logout</button>
      <button class="btn-red" onclick="clearAllMenu()">Clear All Menu (Danger)</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    doc,
    onSnapshot,
    updateDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM",
    authDomain: "sanghx-foods.firebaseapp.com",
    projectId: "sanghx-foods",
    storageBucket: "sanghx-foods.firebasestorage.app",
    messagingSenderId: "491353757911",
    appId: "1:491353757911:web:40752459b5b0049c71f892"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    if(!user) window.location.href = "login.html";
  });

  const CLOUD_NAME = "dvbaqh8ja";
  const UPLOAD_PRESET = "SANGHX";

  const statusText = document.getElementById("statusText");
  const storeStatus = document.getElementById("storeStatus");
  const catStatus = document.getElementById("catStatus");

  const menuList = document.getElementById("menuList");
  const storeList = document.getElementById("storeList");
  const catList = document.getElementById("catList");

  const storeSelect = document.getElementById("storeSelect");
  const categorySelect = document.getElementById("categorySelect");

  const addBtn = document.getElementById("addBtn");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const formTitle = document.getElementById("formTitle");
  const modeTag = document.getElementById("modeTag");

  let STORES = [];
  let CATEGORIES = [];

  let editingId = null;
  let editingOldImg = null;

  function safeText(str){
    return String(str || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function makeId(text){
    return String(text || "")
      .toUpperCase()
      .trim()
      .replace(/\s+/g,"_")
      .replace(/[^A-Z0-9_]/g,"");
  }

  // ===== STORES =====
  window.addStore = async function(){
    try{
      const name = document.getElementById("storeNewName").value.trim();
      const order = Number(document.getElementById("storeOrder").value) || 9999;
      const online = document.getElementById("storeOnline").value === "true";
      const openTime = document.getElementById("openTime").value || "10:00";
      const closeTime = document.getElementById("closeTime").value || "22:30";

      if(!name){
        alert("Enter store name");
        return;
      }

      storeStatus.innerText = "Saving store...";
      const id = makeId(name);

      await setDoc(doc(db, "stores", id), {
        id,
        name,
        order,
        online,
        openTime,
        closeTime,
        createdAt: Date.now()
      });

      document.getElementById("storeNewName").value = "";
      document.getElementById("storeOrder").value = "";

      storeStatus.innerText = "‚úÖ Store added!";
    } catch(err){
      storeStatus.innerText = "‚ùå " + err.message;
      alert(err.message);
    }
  };

  window.toggleStore = async function(id, currentOnline){
    await updateDoc(doc(db, "stores", id), {
      online: !currentOnline,
      updatedAt: Date.now()
    });
  };

  function fillStoreDropdown(){
    storeSelect.innerHTML = "";
    if(STORES.length === 0){
      storeSelect.innerHTML = `<option value="">No stores added</option>`;
      return;
    }
    STORES.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s.id; // ‚úÖ storeId
      opt.textContent = s.name;
      storeSelect.appendChild(opt);
    });
  }

  onSnapshot(collection(db, "stores"), (snap)=>{
    STORES = [];
    snap.forEach(d => STORES.push({ id:d.id, ...d.data() }));
    STORES.sort((a,b)=>(a.order||9999)-(b.order||9999));
    fillStoreDropdown();

    storeList.innerHTML = "";
    if(STORES.length === 0){
      storeList.innerHTML = `<p style="opacity:0.7;margin-top:10px;">No stores added yet</p>`;
      return;
    }

    STORES.forEach(s=>{
      storeList.innerHTML += `
        <div class="storeCard">
          <div class="storeInfo">
            <b>${safeText(s.name)}</b>
            <small>Order: ${s.order ?? 9999} ‚Ä¢ ${s.online ? "üü¢ Online" : "üî¥ Offline"}</small>
            <small>üïí ${safeText(s.openTime||"--:--")} - ${safeText(s.closeTime||"--:--")}</small>
          </div>
          <div class="actions">
            <button class="smallBtn ${s.online ? "btn-black" : "btn-green"}" onclick="toggleStore('${s.id}', ${!!s.online})">
              ${s.online ? "Go Offline" : "Go Online"}
            </button>
          </div>
        </div>
      `;
    });
  });

  // ===== CATEGORIES =====
  window.addCategory = async function(){
    try{
      const name = document.getElementById("newCategory").value.trim();
      if(!name){
        alert("Enter category name");
        return;
      }

      const id = makeId(name);
      catStatus.innerText = "Saving category...";

      await setDoc(doc(db, "categories", id), {
        id,
        name,
        createdAt: Date.now()
      });

      document.getElementById("newCategory").value = "";
      catStatus.innerText = "‚úÖ Category added!";
    } catch(err){
      catStatus.innerText = "‚ùå " + err.message;
      alert(err.message);
    }
  };

  function fillCategoryDropdown(){
    categorySelect.innerHTML = "";
    if(CATEGORIES.length === 0){
      categorySelect.innerHTML = `<option value="">No categories</option>`;
      return;
    }
    CATEGORIES.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.name;
      opt.textContent = c.name;
      categorySelect.appendChild(opt);
    });
  }

  onSnapshot(collection(db, "categories"), (snap)=>{
    CATEGORIES = [];
    snap.forEach(d => CATEGORIES.push({ id:d.id, ...d.data() }));
    CATEGORIES.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    fillCategoryDropdown();

    catList.innerHTML = "";
    if(CATEGORIES.length === 0){
      catList.innerHTML = `<p style="opacity:0.7;margin-top:10px;">No categories added yet</p>`;
      return;
    }

    CATEGORIES.forEach(c=>{
      catList.innerHTML += `
        <div class="storeCard">
          <div class="storeInfo">
            <b>${safeText(c.name)}</b>
            <small>Category</small>
          </div>
        </div>
      `;
    });
  });

  // ===== VARIANTS =====
  const variantsWrap = document.getElementById("variantsWrap");

  function createVariantRow(label="", price=""){
    const row = document.createElement("div");
    row.className = "variantRow";
    row.innerHTML = `
      <input class="vLabel" placeholder="Quantity (e.g. Half KG)" value="${safeText(label)}">
      <input class="vPrice" type="number" placeholder="Price (e.g. 180)" value="${price}">
      <button type="button" class="vDel">X</button>
    `;
    row.querySelector(".vDel").addEventListener("click", ()=> row.remove());
    variantsWrap.appendChild(row);
  }

  window.addVariantRow = function(){ createVariantRow(); };

  function getVariantsFromUI(){
    const rows = variantsWrap.querySelectorAll(".variantRow");
    const variants = [];
    rows.forEach(r=>{
      const label = r.querySelector(".vLabel").value.trim();
      const price = Number(r.querySelector(".vPrice").value);
      if(label && price > 0) variants.push({ label, price });
    });
    return variants;
  }

  function resetForm(){
    document.getElementById("foodName").value = "";
    document.getElementById("foodImg").value = "";
    document.getElementById("priority").value = "";

    variantsWrap.innerHTML = "";
    createVariantRow("Half Plate", 60);
    createVariantRow("Full Plate", 100);
  }
  resetForm();

  async function uploadToCloudinary(file){
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error.message);
    return data.secure_url;
  }

  function setModeAdd(){
    editingId = null;
    editingOldImg = null;
    formTitle.innerText = "üçΩ Add Menu Item";
    modeTag.innerText = "ADD MODE";
    addBtn.style.display = "block";
    saveBtn.style.display = "none";
    cancelBtn.style.display = "none";
  }

  function setModeEdit(){
    formTitle.innerText = "‚úèÔ∏è Edit Menu Item";
    modeTag.innerText = "EDIT MODE";
    addBtn.style.display = "none";
    saveBtn.style.display = "block";
    cancelBtn.style.display = "block";
  }

  window.cancelEdit = function(){
    setModeAdd();
    resetForm();
    statusText.innerText = "Edit cancelled.";
  };

  // ===== ADD MENU ITEM =====
  window.addMenuItem = async function(){
    try{
      const name = document.getElementById("foodName").value.trim();
      const storeId = storeSelect.value; // ‚úÖ storeId
      const storeObj = STORES.find(s=>s.id===storeId);
      const storeName = storeObj ? storeObj.name : "";

      const category = categorySelect.value || "Other";
      const priority = Number(document.getElementById("priority").value) || 9999;
      const file = document.getElementById("foodImg").files[0];
      const variants = getVariantsFromUI();

      if(!name) return alert("Enter food name");
      if(!storeId) return alert("Add store first");
      if(!file) return alert("Select image");
      if(variants.length === 0) return alert("Add at least 1 variant");

      statusText.innerText = "Uploading image...";
      const imgUrl = await uploadToCloudinary(file);

      statusText.innerText = "Saving item...";
      await addDoc(collection(db, "menu"), {
        name,
        img: imgUrl,
        storeId,        // ‚úÖ FIX
        storeName,      // (optional for display)
        category,
        priority,
        variants,
        createdAt: Date.now()
      });

      statusText.innerText = "‚úÖ Item Added!";
      resetForm();

    } catch(err){
      statusText.innerText = "‚ùå " + err.message;
      alert(err.message);
    }
  };

  // ===== MENU LIST =====
  window.editItem = function(id, item){
    editingId = id;
    editingOldImg = item.img || "";

    document.getElementById("foodName").value = item.name || "";
    document.getElementById("priority").value = item.priority ?? "";

    storeSelect.value = item.storeId || ""; // ‚úÖ storeId
    categorySelect.value = item.category || categorySelect.value;

    variantsWrap.innerHTML = "";
    const vars = Array.isArray(item.variants) ? item.variants : [];
    if(vars.length === 0) createVariantRow("Full Plate", 100);
    else vars.forEach(v => createVariantRow(v.label, v.price));

    setModeEdit();
    statusText.innerText = "Editing: " + (item.name || "");
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  window.saveEdit = async function(){
    try{
      if(!editingId) return alert("No item selected");

      const name = document.getElementById("foodName").value.trim();
      const storeId = storeSelect.value;
      const storeObj = STORES.find(s=>s.id===storeId);
      const storeName = storeObj ? storeObj.name : "";

      const category = categorySelect.value || "Other";
      const priority = Number(document.getElementById("priority").value) || 9999;
      const file = document.getElementById("foodImg").files[0];
      const variants = getVariantsFromUI();

      if(!name) return alert("Food name required");
      if(!storeId) return alert("Store required");
      if(variants.length === 0) return alert("Add at least 1 variant");

      statusText.innerText = "Saving changes...";

      let imgUrl = editingOldImg;
      if(file){
        statusText.innerText = "Uploading new image...";
        imgUrl = await uploadToCloudinary(file);
      }

      await updateDoc(doc(db, "menu", editingId), {
        name,
        storeId,
        storeName,
        category,
        priority,
        variants,
        img: imgUrl,
        updatedAt: Date.now()
      });

      statusText.innerText = "‚úÖ Updated!";
      setModeAdd();
      resetForm();

    } catch(err){
      statusText.innerText = "‚ùå " + err.message;
      alert(err.message);
    }
  };

  window.deleteItem = async function(id){
    if(!confirm("Delete this item?")) return;
    await deleteDoc(doc(db, "menu", id));
  };

  window.clearAllMenu = async function(){
    if(!confirm("Delete ALL menu items?")) return;
    const snap = await getDocs(collection(db, "menu"));
    for(const d of snap.docs){
      await deleteDoc(doc(db, "menu", d.id));
    }
    alert("All menu cleared!");
  };

  window.logout = async function(){
    await signOut(auth);
    window.location.href = "login.html";
  };

  // Live menu render
  onSnapshot(collection(db, "menu"), (snapshot) => {
    menuList.innerHTML = "";
    const items = [];
    snapshot.forEach((d) => items.push({ id: d.id, ...d.data() }));

    if(items.length === 0){
      menuList.innerHTML = "<p style='opacity:0.7;margin-top:10px;'>No items added yet</p>";
      return;
    }

    items.sort((a,b)=>(a.priority||9999)-(b.priority||9999));

    items.forEach((item) => {
      const firstVar = item.variants?.[0];
      menuList.innerHTML += `
        <div class="menu-item">
          <img src="${item.img || ""}">
          <div class="menu-info">
            <b>${safeText(item.name)}</b>
            <small>üè™ ${safeText(item.storeName || item.storeId || "")} ‚Ä¢ üè∑Ô∏è ${safeText(item.category||"Other")}</small>
            <small>‚≠ê Priority: ${item.priority ?? 9999} ‚Ä¢ üçΩ ${item.variants?.length || 0} variants</small>
            <small>${firstVar ? `${safeText(firstVar.label)} ‚Çπ${firstVar.price}` : ""}</small>
          </div>
          <div class="actions">
            <button class="smallBtn btn-black"
              onclick='editItem("${item.id}", ${JSON.stringify(item).replace(/</g,"\\u003c")})'>Edit</button>
            <button class="smallBtn btn-red" onclick="deleteItem('${item.id}')">Delete</button>
          </div>
        </div>
      `;
    });
  });
</script>

</body>
</html>
