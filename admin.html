<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SANGHX ‚Ä¢ Admin Mobile</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #4F46E5;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --dark: #111827;
      --light: #F9FAFB;
      --white: #ffffff;
      --sidebar-width: 260px;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color:transparent; }
    body { background: var(--light); color: var(--dark); display: flex; min-height: 100vh; overflow-x: hidden; }

    /* --- SIDEBAR --- */
    .sidebar {
      width: var(--sidebar-width); background: var(--white); position: fixed; height: 100%; top: 0; left: 0;
      border-right: 1px solid #e5e7eb; padding: 20px; z-index: 1000;
      transform: translateX(0); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display:flex; flex-direction:column;
    }

    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .sidebar-overlay.show { opacity: 1; visibility: visible; }

    .logo {
      font-size: 20px; font-weight: 800; color: var(--primary);
      margin-bottom: 22px; display: flex; align-items: center; gap: 10px;
    }

    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 14px 15px;
      color: #6B7280; font-weight: 600; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 5px;
    }
    .nav-item:hover, .nav-item.active { background: #EEF2FF; color: var(--primary); }
    .nav-item i { font-size: 22px; }

    /* --- MAIN --- */
    .main { margin-left: var(--sidebar-width); flex: 1; padding: 20px; width: calc(100% - var(--sidebar-width)); transition: 0.3s; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: var(--light); z-index: 90; padding: 10px 0; }
    .menu-toggle { display: none; font-size: 28px; cursor: pointer; color: var(--dark); }
    .page-title { font-size: 22px; font-weight: 800; }

    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 25px;
    }
    .stat-card { background: var(--white); padding: 16px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .stat-val { font-size: 24px; font-weight: 800; margin-top: 4px; }
    .stat-label { font-size: 11px; color: #9CA3AF; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* Orders */
    .orders-grid { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
    .order-card { background: var(--white); border-radius: 16px; padding: 16px; border: 1px solid #f3f4f6; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }

    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #e5e7eb; }
    .cust-name { font-weight: 700; font-size: 16px; color: var(--dark); }
    .order-time { font-size: 11px; color: #9CA3AF; font-weight: 500; }

    .order-items { margin: 10px 0; font-size: 13px; color: #4B5563; }
    .order-item-row { display: flex; justify-content: space-between; margin-bottom: 6px; }

    .order-total { display: flex; justify-content: space-between; font-weight: 800; margin-top: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; font-size: 15px; }

    .status-badge {
      display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-top: 5px;
    }
    .st-Pending { background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA; }
    .st-Confirmed { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
    .st-Completed { background: #ECFDF5; color: #047857; border: 1px solid #A7F3D0; }
    .st-Cancelled { background: #FEF2F2; color: #B91C1C; border: 1px solid #FECACA; }

    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
    .act-btn { padding: 10px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-accept { background: var(--primary); color: white; }
    .btn-complete { background: var(--success); color: white; }
    .btn-del { background: #FEF2F2; color: #DC2626; border: 1px solid #FEE2E2; }

    /* List items */
    .menu-list-item {
      display: flex; align-items: center; background: var(--white); padding: 12px;
      border-radius: 14px; margin-bottom: 10px; gap: 12px; border: 1px solid #f3f4f6;
    }
    .menu-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; background: #f3f4f6; }
    .menu-info { flex: 1; overflow: hidden; }
    .menu-title { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .menu-sub { font-size: 11px; color: #6B7280; margin-top: 2px; }

    .menu-actions { display: flex; flex-direction: column; gap: 6px; }
    .btn-icon {
      width: 34px; height: 34px; border-radius: 10px; display: flex; justify-content: center; align-items: center;
      border: none; font-size: 18px; cursor: pointer;
    }
    .btn-icon:disabled{opacity:0.35; cursor:not-allowed;}

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
      display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: white; width: 100%; max-width: 100%; padding: 25px 20px;
      border-radius: 20px 20px 0 0; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 85vh; overflow-y: auto;
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    /* Form */
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 14px; background: #F9FAFB; }
    input:focus, select:focus { background: white; border-color: var(--primary); }

    .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; }
    .btn-ghost { background: transparent; color: #666; margin-top: 10px; border: 1px solid #e5e7eb; }

    /* FAB */
    .fab {
      position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
      background: var(--dark); color: white; border-radius: 16px; display: none;
      justify-content: center; align-items: center; font-size: 28px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 90; cursor: pointer; border: none;
    }

    @media(max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 280px; }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; width: 100%; padding: 15px; }
      .menu-toggle { display: block; }
      .header-add-btn { display: none; }
      .fab { display: flex; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .stats-grid .stat-card:last-child { grid-column: 1 / -1; }
    }
  </style>
</head>

<body>

  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <div class="logo">
      <i class='bx bxs-dashboard'></i> SANGHX Admin
      <i class='bx bx-x' onclick="toggleSidebar()" style="margin-left:auto; cursor:pointer; font-size:24px; color:#999;"></i>
    </div>

    <div class="nav-item active" onclick="switchTab('orders')">
      <i class='bx bxs-shopping-bag'></i> Live Orders
    </div>
    <div class="nav-item" onclick="switchTab('menu')">
      <i class='bx bxs-food-menu'></i> Menu Items
    </div>
    <div class="nav-item" onclick="switchTab('stores')">
      <i class='bx bxs-store'></i> Stores & Vendors
    </div>

    <div class="nav-item" onclick="logout()" style="margin-top:auto; color:var(--danger); background:#FEF2F2;">
      <i class='bx bxs-log-out'></i> Logout
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div style="display:flex; align-items:center; gap:15px;">
        <i class='bx bx-menu menu-toggle' onclick="toggleSidebar()"></i>
        <div class="page-title">Dashboard</div>
      </div>
      <button class="btn-primary header-add-btn" style="width:auto; padding:10px 20px;" onclick="openAddModal()">
        + Add New
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-val" style="color:var(--warning)" id="countPending">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Revenue</div>
        <div class="stat-val" style="color:var(--success)" id="totalRevenue">‚Çπ0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Items</div>
        <div class="stat-val" id="totalMenu">0</div>
      </div>
    </div>

    <div id="view-orders" class="section active">
      <div class="orders-grid" id="ordersList"></div>
    </div>

    <div id="view-menu" class="section">
      <div id="menuList"></div>
    </div>

    <div id="view-stores" class="section">
      <div id="storeList"></div>
    </div>
  </div>

  <button class="fab" onclick="openAddModal()"><i class='bx bx-plus'></i></button>

  <!-- MENU MODAL -->
  <div class="modal-overlay" id="menuModal">
    <div class="modal-box">
      <h2 style="margin-bottom:16px;" id="modalTitle">Add Item</h2>

      <input id="foodName" placeholder="Item Name (e.g. Chicken Biryani)">
      <select id="storeSelect"><option value="">Select Store</option></select>

      <label style="font-size:12px; font-weight:700; color:#666; margin-bottom:5px; display:block;">Food Image</label>
      <input type="file" id="foodImg" style="padding:10px;">

      <input type="number" id="priority" placeholder="Priority (1 = Top)">

      <div style="background:#F3F4F6; padding:15px; border-radius:12px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <small style="font-weight:800; color:#374151;">VARIANTS</small>
          <small onclick="addVariantRow()" style="color:var(--primary); font-weight:700; cursor:pointer;">+ Add Row</small>
        </div>
        <div id="variantsWrap"></div>
        <small style="display:block; margin-top:6px; color:#6B7280; font-weight:600; font-size:12px;">
          Example: Half Plate ‚Çπ80, Full Plate ‚Çπ150
        </small>
      </div>

      <button class="btn-primary" onclick="saveItem()">Save Item</button>
      <button class="btn-primary btn-ghost" onclick="closeModal('menuModal')">Cancel</button>
      <div id="status" style="margin-top:12px; text-align:center; font-size:13px; font-weight:700; color:var(--primary);"></div>
    </div>
  </div>

  <!-- STORE MODAL -->
  <div class="modal-overlay" id="storeModal">
    <div class="modal-box">
      <h2 style="margin-bottom:16px;" id="storeModalTitle">Add Store</h2>
      <input id="stName" placeholder="Store Name">
      <div style="display:flex; gap:10px;">
        <input id="stOpen" placeholder="Open (10:00 AM)">
        <input id="stClose" placeholder="Close (10:00 PM)">
      </div>
      <input type="number" id="stPrio" placeholder="Position (1 = Top)">
      <button class="btn-primary" onclick="saveStore()">Save Store</button>
      <button class="btn-primary btn-ghost" onclick="closeModal('storeModal')">Cancel</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    doc,
    onSnapshot,
    updateDoc,
    query,
    orderBy,
    getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ‚úÖ Firebase
  const app = initializeApp({
    apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM",
    authDomain: "sanghx-foods.firebaseapp.com",
    projectId: "sanghx-foods",
    storageBucket: "sanghx-foods.firebasestorage.app",
    messagingSenderId: "491353757911",
    appId: "1:491353757911:web:40752459b5b0049c71f892"
  });

  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, u => { if(!u) location.href="login.html"; });

  // Cloudinary (for menu image upload)
  const CLOUD_NAME = "dvbaqh8ja";
  const UPLOAD_PRESET = "SANGHX";

  // UI State
  let currentTab = 'orders';

  // Menu edit state
  let editingMenuId = null;
  let editingOldImg = null;

  // Store edit state
  let editingStoreId = null;

  // --- MOBILE SIDEBAR ---
  window.toggleSidebar = () => {
    document.getElementById('sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay').classList.toggle('show');
  }

  window.switchTab = (tab) => {
    currentTab = tab;
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById(`view-${tab}`).classList.add('active');
    const idx = ['orders', 'menu', 'stores'].indexOf(tab);
    document.querySelectorAll('.nav-item')[idx].classList.add('active');

    document.querySelector('.page-title').innerText =
      tab === 'orders' ? 'Live Orders' : (tab === 'menu' ? 'Menu Items' : 'Stores & Vendors');

    if(window.innerWidth < 768) toggleSidebar();
  }

  // --- MODALS ---
  window.openAddModal = () => {
    if(currentTab === 'menu') {
      editingMenuId = null;
      editingOldImg = null;
      document.getElementById('modalTitle').innerText = "Add New Item";
      document.getElementById('foodName').value = "";
      document.getElementById('priority').value = "";
      document.getElementById('foodImg').value = "";
      document.getElementById('status').innerText = "";
      document.getElementById('variantsWrap').innerHTML = "";
      addVariantRow("Half Plate", 80);
      addVariantRow("Full Plate", 150);
      document.getElementById('menuModal').classList.add('open');
    }
    else if(currentTab === 'stores') {
      editingStoreId = null;
      document.getElementById('storeModalTitle').innerText = "Add Store";
      document.getElementById('stName').value = "";
      document.getElementById('stOpen').value = "";
      document.getElementById('stClose').value = "";
      document.getElementById('stPrio').value = "";
      document.getElementById('storeModal').classList.add('open');
    }
    else {
      alert("Switch to Menu or Stores tab first!");
    }
  }

  window.closeModal = (id) => document.getElementById(id).classList.remove('open');

  // --- VARIANTS UI ---
  window.addVariantRow = (label="", price="") => {
    const wrap = document.getElementById("variantsWrap");
    const row = document.createElement("div");
    row.style.cssText = "display:flex; gap:8px; margin-bottom:8px;";
    row.innerHTML = `
      <input class="vLabel" placeholder="Label (Half KG)" value="${label}" style="margin:0; flex:1;">
      <input class="vPrice" type="number" placeholder="Price (180)" value="${price}" style="margin:0; width:120px;">
      <button class="btn-icon" style="background:#FEE2E2; color:#B91C1C; width:40px; height:40px; border-radius:12px;" type="button">‚úï</button>
    `;
    row.querySelector("button").onclick = () => row.remove();
    wrap.appendChild(row);
  }

  function getVariants(){
    const rows = document.querySelectorAll("#variantsWrap > div");
    const variants = [];
    rows.forEach(r=>{
      const label = r.querySelector(".vLabel").value.trim();
      const price = Number(r.querySelector(".vPrice").value);
      if(label && price > 0) variants.push({ label, price });
    });
    return variants;
  }

  async function uploadToCloudinary(file){
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error.message);
    return data.secure_url;
  }

  // --- ORDERS ---
  const qOrders = query(collection(db, "orders"), orderBy("timestamp", "desc"));
  onSnapshot(qOrders, (snapshot) => {
    const list = document.getElementById("ordersList");
    list.innerHTML = "";
    let pendingCount = 0, revenue = 0;

    if(snapshot.empty) {
      list.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>No Orders Yet</div>";
      document.getElementById("countPending").innerText = "0";
      document.getElementById("totalRevenue").innerText = "‚Çπ0";
      return;
    }

    snapshot.forEach(docSnap => {
      const order = docSnap.data();
      const oid = docSnap.id;

      if(order.status === "Pending") pendingCount++;
      if(order.status === "Completed") revenue += (order.bill?.total || 0);

      const itemsHtml = (order.items || []).map(i => `
        <div class="order-item-row">
          <span>${i.qty}x ${i.name} <small style="opacity:.6;">(${i.variantLabel||""})</small></span>
          <span>‚Çπ${(i.price||0) * (i.qty||0)}</span>
        </div>
      `).join("");

      let btns = "";
      if(order.status === "Pending") {
        btns = `
          <button class="act-btn btn-accept" onclick="updateStatus('${oid}','Confirmed')">Accept</button>
          <button class="act-btn btn-del" onclick="updateStatus('${oid}','Cancelled')">Reject</button>
        `;
      } else if(order.status === "Confirmed") {
        btns = `
          <button class="act-btn btn-complete" style="grid-column:1/-1" onclick="updateStatus('${oid}','Completed')">
            Mark Delivered
          </button>
        `;
      }

      const timeTxt = order.timestamp?.toDate ? new Date(order.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";

      list.innerHTML += `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="cust-name">${order.customer?.name || "Customer"}</div>
              <div class="order-time">${timeTxt}</div>
            </div>
            ${order.customer?.location ? `<a href="${order.customer.location}" target="_blank"
              style="background:#EEF2FF; width:36px; height:36px; display:flex; justify-content:center; align-items:center; border-radius:50%; color:var(--primary);">
              <i class='bx bxs-map'></i></a>` : ""}
          </div>

          <div style="font-size:12px; margin-bottom:10px; color:#666;">
             üìû <a href="tel:${order.customer?.mobile || ""}">${order.customer?.mobile || ""}</a> ‚Ä¢ ${order.customer?.address || ""}
          </div>

          <div class="order-items">${itemsHtml}</div>

          <div class="order-total">
            <span>Total (${order.payment || "NA"})</span>
            <span>‚Çπ${order.bill?.total || 0}</span>
          </div>

          <div style="text-align:right;">
            <span class="status-badge st-${order.status || "Pending"}">${order.status || "Pending"}</span>
          </div>

          <div class="action-btns">${btns}</div>
        </div>
      `;
    });

    document.getElementById("countPending").innerText = pendingCount;
    document.getElementById("totalRevenue").innerText = "‚Çπ" + revenue;
  });

  window.updateStatus = async (id, st) => {
    if(confirm(`Mark ${st}?`)) await updateDoc(doc(db,"orders",id), {status:st});
  }

  // --- MENU LIST ---
  onSnapshot(collection(db, "menu"), snap => {
    const list = document.getElementById("menuList");
    list.innerHTML = "";
    document.getElementById("totalMenu").innerText = snap.size;

    const items = [];
    snap.forEach(d => items.push({id:d.id, ...d.data()}));
    items.sort((a,b)=>(a.priority||9999)-(b.priority||9999));

    if(items.length === 0){
      list.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>No Menu Items</div>";
      return;
    }

    items.forEach(i => {
      const firstVar = i.variants?.[0] ? `${i.variants[0].label} ‚Çπ${i.variants[0].price}` : "No variants";
      list.innerHTML += `
        <div class="menu-list-item">
          <img src="${i.img || ""}" class="menu-img" onerror="this.src='https://via.placeholder.com/120x120?text=No+Img'">
          <div class="menu-info">
            <div class="menu-title">${i.name || "Item"}</div>
            <div class="menu-sub">üè™ ${i.storeName || "Store"} ‚Ä¢ ‚≠ê Priority: ${i.priority ?? 9999}</div>
            <div class="menu-sub">üçΩ ${firstVar}</div>
          </div>
          <div class="menu-actions">
            <button class="btn-icon" style="background:#F3F4F6;" onclick='editMenu("${i.id}", ${JSON.stringify(i).replace(/</g,"\\u003c")})'>
              <i class='bx bxs-edit'></i>
            </button>
            <button class="btn-icon" style="background:#FEE2E2; color:red;" onclick="deleteMenu('${i.id}')">
              <i class='bx bxs-trash'></i>
            </button>
          </div>
        </div>
      `;
    });
  });

  window.editMenu = (id, item) => {
    editingMenuId = id;
    editingOldImg = item.img || "";

    document.getElementById("modalTitle").innerText = "Edit Item";
    document.getElementById("foodName").value = item.name || "";
    document.getElementById("storeSelect").value = item.storeName || "";
    document.getElementById("priority").value = item.priority ?? "";
    document.getElementById("foodImg").value = "";
    document.getElementById("status").innerText = "";

    const wrap = document.getElementById("variantsWrap");
    wrap.innerHTML = "";
    const vars = Array.isArray(item.variants) ? item.variants : [];
    if(vars.length === 0){
      addVariantRow("Full Plate", 100);
    } else {
      vars.forEach(v=> addVariantRow(v.label, v.price));
    }

    document.getElementById("menuModal").classList.add("open");
  }

  window.deleteMenu = async (id) => {
    if(!confirm("Delete this menu item?")) return;
    await deleteDoc(doc(db, "menu", id));
  }

  window.saveItem = async () => {
    try{
      const name = document.getElementById("foodName").value.trim();
      const storeName = document.getElementById("storeSelect").value;
      const priority = Number(document.getElementById("priority").value) || 9999;
      const file = document.getElementById("foodImg").files[0];
      const variants = getVariants();

      if(!name) return alert("Item name required");
      if(!storeName) return alert("Select store");
      if(variants.length === 0) return alert("Add at least 1 variant");

      document.getElementById("status").innerText = "Saving...";

      let imgUrl = editingOldImg || "";
      if(file){
        document.getElementById("status").innerText = "Uploading image...";
        imgUrl = await uploadToCloudinary(file);
      }

      if(!imgUrl) return alert("Image required (upload once)");

      if(editingMenuId){
        await updateDoc(doc(db, "menu", editingMenuId), {
          name,
          storeName,
          priority,
          variants,
          img: imgUrl,
          updatedAt: Date.now()
        });
      } else {
        await addDoc(collection(db, "menu"), {
          name,
          storeName,
          priority,
          variants,
          img: imgUrl,
          createdAt: Date.now()
        });
      }

      document.getElementById("status").innerText = "‚úÖ Saved!";
      setTimeout(()=> closeModal("menuModal"), 500);

    } catch(err){
      console.log(err);
      alert(err.message);
      document.getElementById("status").innerText = "‚ùå " + err.message;
    }
  }

  // --- STORES LIST (WITH MOVE UP/DOWN + EDIT + DELETE + ONLINE/OFFLINE) ---
  onSnapshot(collection(db, "stores"), snap => {
    const list = document.getElementById("storeList");
    const select = document.getElementById("storeSelect");

    list.innerHTML = "";
    select.innerHTML = "<option value=''>Select Store</option>";

    let stores = [];
    snap.forEach(docSnap => {
      stores.push({ id: docSnap.id, ...docSnap.data() });
    });

    stores.sort((a,b) => (a.order ?? 9999) - (b.order ?? 9999));

    stores.forEach(s => {
      select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
    });

    if(stores.length === 0){
      list.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>No Stores Added</div>";
      return;
    }

    stores.forEach((s, idx) => {
      const isOnline = !!s.isOnline;
      const badgeClass = isOnline ? "st-Completed" : "st-Cancelled";
      const badgeText = isOnline ? "Online" : "Offline";

      list.innerHTML += `
        <div class="menu-list-item">
          <div class="menu-info">
            <div class="menu-title">${s.name || "Store"}</div>
            <div class="menu-sub">‚è∞ ${s.openTime || "--"} - ${s.closeTime || "--"}</div>
            <div class="menu-sub">üìå Position: <b>${(s.order ?? 9999)}</b></div>
            <span class="status-badge ${badgeClass}">${badgeText}</span>
          </div>

          <div class="menu-actions">
            <button class="btn-icon" style="background:${isOnline ? '#D1FAE5' : '#FEE2E2'}; color:${isOnline ? '#065F46' : '#B91C1C'}"
              onclick="toggleStore('${s.id}', ${isOnline})">
              <i class='bx bx-power-off'></i>
            </button>

            <button class="btn-icon" style="background:#EEF2FF; color:#3730A3"
              onclick="moveStoreUp('${s.id}')" ${idx === 0 ? "disabled" : ""}>
              <i class='bx bx-up-arrow-alt'></i>
            </button>

            <button class="btn-icon" style="background:#EEF2FF; color:#3730A3"
              onclick="moveStoreDown('${s.id}')" ${idx === stores.length - 1 ? "disabled" : ""}>
              <i class='bx bx-down-arrow-alt'></i>
            </button>

            <button class="btn-icon" style="background:#F3F4F6;" onclick='editStore("${s.id}", ${JSON.stringify(s).replace(/</g,"\\u003c")})'>
              <i class='bx bxs-edit'></i>
            </button>

            <button class="btn-icon" style="background:#FEE2E2; color:red;" onclick="deleteStore('${s.id}')">
              <i class='bx bxs-trash'></i>
            </button>
          </div>
        </div>
      `;
    });
  });

  window.toggleStore = async (id, current) => {
    await updateDoc(doc(db, "stores", id), {
      isOnline: !current,
      updatedAt: Date.now()
    });
  }

  window.deleteStore = async (id) => {
    if(!confirm("Delete this store?")) return;
    await deleteDoc(doc(db, "stores", id));
  }

  window.editStore = (id, s) => {
    editingStoreId = id;
    document.getElementById("storeModalTitle").innerText = "Edit Store";
    document.getElementById("stName").value = s.name || "";
    document.getElementById("stOpen").value = s.openTime || "";
    document.getElementById("stClose").value = s.closeTime || "";
    document.getElementById("stPrio").value = s.order ?? "";
    document.getElementById("storeModal").classList.add("open");
  }

  window.saveStore = async () => {
    const name = document.getElementById("stName").value.trim();
    const openTime = document.getElementById("stOpen").value.trim() || "10:00 AM";
    const closeTime = document.getElementById("stClose").value.trim() || "10:00 PM";
    const order = Number(document.getElementById("stPrio").value) || 9999;

    if(!name) return alert("Store name required");

    if(editingStoreId){
      await updateDoc(doc(db, "stores", editingStoreId), {
        name,
        openTime,
        closeTime,
        order,
        updatedAt: Date.now()
      });
    } else {
      await addDoc(collection(db, "stores"), {
        name,
        openTime,
        closeTime,
        order,
        isOnline: true,
        createdAt: Date.now()
      });
    }

    closeModal("storeModal");
  }

  window.moveStoreUp = async (storeId) => {
    const snap = await getDocs(collection(db, "stores"));
    let stores = [];
    snap.forEach(d => stores.push({ id: d.id, ...d.data() }));
    stores.sort((a,b)=>(a.order ?? 9999)-(b.order ?? 9999));

    const idx = stores.findIndex(s => s.id === storeId);
    if(idx <= 0) return;

    const current = stores[idx];
    const prev = stores[idx - 1];

    const currentOrder = current.order ?? 9999;
    const prevOrder = prev.order ?? 9999;

    await updateDoc(doc(db, "stores", current.id), { order: prevOrder });
    await updateDoc(doc(db, "stores", prev.id), { order: currentOrder });
  }

  window.moveStoreDown = async (storeId) => {
    const snap = await getDocs(collection(db, "stores"));
    let stores = [];
    snap.forEach(d => stores.push({ id: d.id, ...d.data() }));
    stores.sort((a,b)=>(a.order ?? 9999)-(b.order ?? 9999));

    const idx = stores.findIndex(s => s.id === storeId);
    if(idx === -1 || idx >= stores.length - 1) return;

    const current = stores[idx];
    const next = stores[idx + 1];

    const currentOrder = current.order ?? 9999;
    const nextOrder = next.order ?? 9999;

    await updateDoc(doc(db, "stores", current.id), { order: nextOrder });
    await updateDoc(doc(db, "stores", next.id), { order: currentOrder });
  }

  // --- LOGOUT ---
  window.logout = async () => {
    await signOut(auth);
    location.href = "login.html";
  }
</script>

</body>
</html>
