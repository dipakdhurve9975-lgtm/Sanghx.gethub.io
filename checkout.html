<!DOCTYPE html>
<html lang="en">
<head>
  <title>Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --p:#ff3f34; --bg:#f1f2f6; --dark:#111; --green:#25D366; }
    body { font-family:'Outfit',sans-serif; background:var(--bg); padding:20px; max-width:520px; margin:auto; }

    h2{ margin-bottom:15px; }

    .card { background:white; padding:20px; border-radius:16px; margin-bottom:15px; box-shadow:0 4px 15px rgba(0,0,0,0.03); }
    .item-row { display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; gap:10px; }
    .bill-box { background:#f9f9f9; padding:15px; border-radius:10px; margin-top:10px; }

    input, textarea {
      width:100%; padding:14px; margin-bottom:12px; border:1px solid #ddd;
      border-radius:10px; outline:none; font-family:inherit; transition:0.3s;
    }
    input:focus, textarea:focus { border-color:var(--p); background:#fff5f5; }

    .btn {
      width:100%; padding:16px; border:none; border-radius:12px; font-weight:800;
      font-size:16px; cursor:pointer; display:flex; justify-content:center; align-items:center; gap:8px;
    }
    .btn-pay { background:var(--green); color:white; margin-top:10px; box-shadow:0 5px 15px rgba(37,211,102,0.3); opacity:0.7; }
    .btn-pay.enabled { opacity:1; }

    .btn-loc { background:#1e272e; color:white; }

    .status { text-align:center; margin-top:8px; font-size:12px; font-weight:800; color:#555; }
    .small { font-size:11px; color:#888; margin-top:6px; }

    .store-title{
      font-weight:900; font-size:15px; margin-bottom:10px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .badge{
      font-size:10px; padding:5px 10px; border-radius:999px; font-weight:900;
      background:#111; color:white;
    }

    .toggle-wrap{
      display:flex; gap:10px; margin-top:10px;
    }
    .toggle{
      flex:1;
      padding:12px;
      border-radius:12px;
      border:2px solid #eee;
      font-weight:900;
      cursor:pointer;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .toggle.active{
      border-color:var(--p);
      background:#fff5f5;
      color:var(--p);
    }

    .paybox{
      background:#f9f9f9;
      padding:14px;
      border-radius:12px;
      margin-top:12px;
      border:1px dashed #ddd;
    }
    .upi-btn{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background:#111;
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-top:10px;
    }
  </style>
</head>
<body>

  <h2>Checkout üõçÔ∏è</h2>

  <!-- CART + BILL -->
  <div class="card">
    <div id="cartStores"></div>
    <div class="bill-box">
      <div class="item-row"><span>Total Subtotal</span> <span id="sub">‚Çπ0</span></div>
      <div class="item-row"><span>Total Delivery</span> <span id="delivery">‚Çπ0</span></div>
      <div class="item-row"><span>Discount</span> <span id="disc" style="color:green;">-‚Çπ0</span></div>

      <div class="item-row" style="font-weight:900; font-size:18px; border-top:1px dashed #ccc; padding-top:10px; margin-top:5px;">
        <span>To Pay</span> <span id="total">‚Çπ0</span>
      </div>
    </div>
  </div>

  <!-- PAYMENT MODE -->
  <div class="card">
    <h3 style="margin-bottom:10px;">Payment Mode</h3>

    <div class="toggle-wrap">
      <div class="toggle active" id="codToggle" onclick="setPayMode('COD')">
        <i class='bx bx-package'></i> COD
      </div>
      <div class="toggle" id="upiToggle" onclick="setPayMode('UPI')">
        <i class='bx bx-rupee'></i> Pay Online
      </div>
    </div>

    <div class="paybox" id="upiBox" style="display:none;">
      <b>Pay via UPI</b>
      <div class="small">After payment, click ‚ÄúConfirm Order‚Äù and we‚Äôll verify on WhatsApp ‚úÖ</div>

      <button class="upi-btn" onclick="payNowUPI()">
        <i class='bx bx-credit-card'></i> Pay Now (UPI)
      </button>
    </div>
  </div>

  <!-- DELIVERY DETAILS -->
  <div class="card">
    <h3 style="margin-bottom:10px;">Delivery Details</h3>
    <input id="name" placeholder="Full Name">
    <input id="mobile" type="number" placeholder="Phone Number">
    <textarea id="address" placeholder="Full Address (House No, Area, Landmark)"></textarea>

    <button class="btn btn-loc" onclick="getLocation()" id="locBtn">
      <i class='bx bxs-map'></i> Attach Exact Location
    </button>
    <div class="status" id="locMsg">GPS not attached yet</div>
    <div class="small">‚ö†Ô∏è Location is required to confirm order</div>
  </div>

  <button class="btn btn-pay" onclick="placeOrder()" id="payBtn" disabled>
    Confirm Order on WhatsApp <i class='bx bxl-whatsapp'></i>
  </button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const db = getFirestore(initializeApp({
    apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM",
    projectId: "sanghx-foods"
  }));

  // ---- SETTINGS ----
  const DELIVERY_FEE_PER_STORE = 10; // delivery per store order
  const WHATSAPP_NUMBER = "919322586177";

  // ‚úÖ YOUR REAL UPI ID (UPDATED)
  const UPI_ID = "samyaksangode0-2@okicici";
  const UPI_NAME = "SANGHX";

  // Auto-Fill Profile from Memory
  document.getElementById("name").value = localStorage.getItem("uName") || "";
  document.getElementById("mobile").value = localStorage.getItem("uMob") || "";
  document.getElementById("address").value = localStorage.getItem("uAddr") || "";

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let discount = 0;
  let userLoc = "";
  let payMode = "COD"; // COD default

  if(cart.length === 0){
    document.body.innerHTML = "<center><h1>Cart is Empty üò≠</h1><a href='customer.html' style='font-weight:900;color:#ff3f34;'>Go Back</a></center>";
  }

  // ---- STORE-WISE GROUPING ----
  function groupByStore(items){
    const map = {};
    items.forEach(i=>{
      const store = i.storeName || "Unknown Store";
      if(!map[store]) map[store] = [];
      map[store].push(i);
    });
    return map;
  }

  function calcSubtotal(items){
    return items.reduce((a,b)=>a + (Number(b.price) * Number(b.qty)), 0);
  }

  function renderStoreWiseCart(){
    const wrap = document.getElementById("cartStores");
    const grouped = groupByStore(cart);
    const storeNames = Object.keys(grouped);

    wrap.innerHTML = storeNames.map((storeName, idx)=>{
      const items = grouped[storeName];
      const sub = calcSubtotal(items);
      const delivery = DELIVERY_FEE_PER_STORE;

      const itemsHTML = items.map(i=>{
        const v = i.variant || "Regular";
        return `
          <div class="item-row">
            <span>${i.qty}x ${i.name} (${v})</span>
            <b>‚Çπ${Number(i.price) * Number(i.qty)}</b>
          </div>
        `;
      }).join("");

      return `
        <div style="margin-bottom:14px;">
          <div class="store-title">
            <span>${storeName}</span>
            <span class="badge">ORDER ${idx+1}</span>
          </div>

          ${itemsHTML}

          <div class="bill-box" style="margin-top:10px;">
            <div class="item-row"><span>Store Subtotal</span><b>‚Çπ${sub}</b></div>
            <div class="item-row"><span>Delivery</span><b>‚Çπ${delivery}</b></div>
            <div class="item-row" style="font-weight:900;border-top:1px dashed #ccc;padding-top:10px;margin-top:5px;">
              <span>Store Total</span><b>‚Çπ${sub + delivery}</b>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderGrandBill(){
    const grouped = groupByStore(cart);
    const storeNames = Object.keys(grouped);

    const totalSub = storeNames.reduce((sum, s)=> sum + calcSubtotal(grouped[s]), 0);
    const totalDelivery = storeNames.length * DELIVERY_FEE_PER_STORE;

    const totalPay = totalSub + totalDelivery - discount;

    document.getElementById("sub").innerText = "‚Çπ" + totalSub;
    document.getElementById("delivery").innerText = "‚Çπ" + totalDelivery;
    document.getElementById("disc").innerText = "-‚Çπ" + discount;
    document.getElementById("total").innerText = "‚Çπ" + totalPay;

    return { totalSub, totalDelivery, totalPay, storeCount: storeNames.length };
  }

  // ---- PAYMENT MODE TOGGLE ----
  window.setPayMode = (mode) => {
    payMode = mode;

    document.getElementById("codToggle").classList.toggle("active", mode==="COD");
    document.getElementById("upiToggle").classList.toggle("active", mode==="UPI");

    document.getElementById("upiBox").style.display = (mode==="UPI") ? "block" : "none";
  };

  // ---- PAY NOW UPI ----
  window.payNowUPI = () => {
    const bill = renderGrandBill();
    const amt = bill.totalPay;

    const note = encodeURIComponent(`SANGHX Order ‚Ä¢ ${bill.storeCount} store(s)`);
    const upiUrl = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent(UPI_NAME)}&am=${amt}&cu=INR&tn=${note}`;

    window.location.href = upiUrl;
  };

  // ---- LOCATION ----
  window.getLocation = () => {
    const btn = document.getElementById("locBtn");
    const msg = document.getElementById("locMsg");

    btn.innerHTML = "Detecting GPS...";
    msg.innerText = "Waiting for permission...";

    if(!navigator.geolocation){
      alert("GPS not supported on this device");
      btn.innerHTML = "<i class='bx bxs-map'></i> Attach Exact Location";
      msg.innerText = "GPS not supported";
      return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      userLoc = `https://www.google.com/maps?q=${lat},${lng}`;

      btn.innerHTML = "‚úÖ GPS Locked";
      btn.style.background = "#25D366";

      msg.innerText = "Location attached ‚úÖ";

      const payBtn = document.getElementById("payBtn");
      payBtn.disabled = false;
      payBtn.classList.add("enabled");

    }, () => {
      alert("Allow Location Access");
      btn.innerHTML = "<i class='bx bxs-map'></i> Attach Exact Location";
      msg.innerText = "Location not attached ‚ùå";
    });
  };

  // ---- PLACE ORDER (STORE-WISE) ----
  window.placeOrder = async () => {
    const n = document.getElementById("name").value.trim();
    const m = document.getElementById("mobile").value.trim();
    const a = document.getElementById("address").value.trim();

    if(!n || !m || !a) return alert("Fill all details");
    if(!userLoc) return alert("Attach GPS location first");

    localStorage.setItem("uName", n);
    localStorage.setItem("uMob", m);
    localStorage.setItem("uAddr", a);

    const payBtn = document.getElementById("payBtn");
    payBtn.innerText = "Processing...";
    payBtn.disabled = true;

    const grouped = groupByStore(cart);
    const storeNames = Object.keys(grouped);

    const bill = renderGrandBill();

    // Save in Firestore (1 order doc, with storeWise breakdown)
    await addDoc(collection(db, "orders"), {
      customer: { name:n, mobile:m, address:a, location:userLoc },
      payMode,
      storeWise: storeNames.map(storeName => ({
        storeName,
        items: grouped[storeName],
        subtotal: calcSubtotal(grouped[storeName]),
        deliveryFee: DELIVERY_FEE_PER_STORE,
        total: calcSubtotal(grouped[storeName]) + DELIVERY_FEE_PER_STORE
      })),
      subtotal: bill.totalSub,
      deliveryFee: bill.totalDelivery,
      discount,
      total: bill.totalPay,
      status: "Pending",
      timestamp: serverTimestamp()
    });

    // WhatsApp message (Store wise)
    let msg = `*NEW ORDER* üî•%0a`;
    msg += `üë§ ${encodeURIComponent(n)}%0a`;
    msg += `üìû ${encodeURIComponent(m)}%0a`;
    msg += `üè† ${encodeURIComponent(a)}%0a`;
    msg += `üìç Map: ${encodeURIComponent(userLoc)}%0a%0a`;
    msg += `üí≥ Payment: *${encodeURIComponent(payMode)}*%0a%0a`;

    storeNames.forEach((storeName, idx)=>{
      const items = grouped[storeName];
      const sub = calcSubtotal(items);
      const del = DELIVERY_FEE_PER_STORE;
      const total = sub + del;

      msg += `*STORE ${idx+1}: ${encodeURIComponent(storeName)}*%0a`;
      items.forEach(i=>{
        const v = i.variant || "Regular";
        msg += `‚ñ™ ${i.qty}x ${encodeURIComponent(i.name)} (${encodeURIComponent(v)})%0a`;
      });
      msg += `Subtotal: ‚Çπ${sub}%0aDelivery: ‚Çπ${del}%0aStore Total: ‚Çπ${total}%0a%0a`;
    });

    msg += `--------------------------------%0a`;
    msg += `Total Subtotal: ‚Çπ${bill.totalSub}%0a`;
    msg += `Total Delivery: ‚Çπ${bill.totalDelivery}%0a`;
    msg += `Discount: -‚Çπ${discount}%0a`;
    msg += `üí∞ *TOTAL PAY: ‚Çπ${bill.totalPay}*%0a`;

    localStorage.removeItem("cart");
    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
  };

  // INIT
  renderStoreWiseCart();
  renderGrandBill();
</script>
</body>
</html>
