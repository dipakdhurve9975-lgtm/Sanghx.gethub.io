<!DOCTYPE html>
<html lang="en">
<head>
  <title>SANGHX ‚Ä¢ Secure Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #FF4B3A;
      --dark: #0d0d0d;
      --gray: #f2f2f5;
      --green: #2ecc71;
      --red: #ff3b3b;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit', sans-serif; -webkit-tap-highlight-color:transparent; }
    body { background: var(--gray); padding: 20px; max-width: 600px; margin: auto; padding-bottom: 100px; }

    .header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .header i { font-size: 28px; color: var(--dark); cursor: pointer; }
    .header h2 { font-size: 22px; font-weight: 800; }

    .card {
      background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); position: relative; overflow: hidden;
    }
    .card-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

    .order-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; border-bottom: 1px solid #f5f5f5; padding-bottom: 8px; }
    .order-item b { font-weight: 700; }

    .bill-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #666; }
    .total-row { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #eee; font-size: 18px; font-weight: 800; color: var(--dark); }

    .input-group { position: relative; margin-bottom: 15px; }
    .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888; font-size: 20px; }
    input, textarea {
      width: 100%; padding: 14px 14px 14px 45px; border-radius: 14px; border: 1px solid #eee;
      background: #f9f9f9; outline: none; font-size: 15px; font-weight: 500; transition: 0.3s;
    }
    input:focus, textarea:focus { border-color: var(--primary); background: white; }
    textarea { height: 80px; padding-left: 15px; }

    .btn {
      width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 16px; font-weight: 700;
      cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s;
    }
    .btn-gps { background: var(--dark); color: white; margin-top: 10px; }
    .btn-gps.active { background: var(--green); }

    .pay-opt {
      display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 16px;
      margin-bottom: 10px; cursor: pointer; transition: 0.3s;
      user-select: none;
    }
    .pay-opt.active { border-color: var(--primary); background: #fff0f0; }
    .radio-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; margin-right: 15px; position: relative; }
    .pay-opt.active .radio-circle { border-color: var(--primary); }
    .pay-opt.active .radio-circle::after { content: ''; position: absolute; inset: 4px; background: var(--primary); border-radius: 50%; }

    .bottom-bar {
      position: fixed; bottom: 0; left: 0; width: 100%; background: white;
      padding: 15px 20px; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .place-btn {
      width: 100%; padding: 16px; background: linear-gradient(135deg, #FF4B3A, #ff7f50);
      color: white; border: none; border-radius: 16px; font-size: 18px; font-weight: 800;
      box-shadow: 0 10px 20px rgba(255, 75, 58, 0.3); cursor: pointer;
      transition: 0.2s;
    }
    .place-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      background: #999;
      box-shadow: none;
    }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-card {
      background: white; padding: 30px; border-radius: 24px; text-align: center; width: 100%;
      max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .km-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fff;
      margin-top:10px;
    }
    .km-pill.ok{ color: var(--green); border-color:#b8f0d0; background:#eafff2; }
    .km-pill.no{ color: var(--red); border-color:#ffd0d0; background:#fff1f1; }

    .fee-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fff;
      margin-top:10px;
      color:#111;
    }

    @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
    .animate { animation: slideUp 0.4s ease forwards; }
  </style>
</head>

<body>

  <div class="header">
    <i class='bx bx-left-arrow-alt' onclick="location.href='index.html'"></i>
    <h2>Checkout</h2>
  </div>

  <div class="animate">

    <div class="card">
      <div class="card-title"><i class='bx bxs-receipt'></i> Order Summary</div>
      <div id="orderItems"></div>

      <div style="margin-top:15px;">
        <div class="bill-row"><span>Item Total</span> <span id="subtotal">‚Çπ0</span></div>
        <div class="bill-row"><span>Delivery Charge</span> <span id="deliveryFeeText">Attach GPS</span></div>
        <div class="total-row"><span>To Pay</span> <span id="grandTotal">‚Çπ0</span></div>

        <div id="feeRulePill" class="fee-pill" style="display:none;"></div>
      </div>
    </div>

    <div class="card" style="animation-delay: 0.1s;">
      <div class="card-title"><i class='bx bxs-user-detail'></i> Delivery Details</div>

      <div class="input-group">
        <i class='bx bxs-user'></i>
        <input id="name" placeholder="Full Name">
      </div>

      <div class="input-group">
        <i class='bx bxs-phone'></i>
        <input id="mobile" type="number" placeholder="Mobile Number">
      </div>

      <textarea id="address" placeholder="Full Address (House No, Area, Landmark)"></textarea>

      <button class="btn btn-gps" onclick="getLocation()" id="gpsBtn">
        <i class='bx bxs-map'></i> Use Current Location
      </button>

      <div id="gpsStatus" style="font-size:12px; margin-top:8px; text-align:center; color:gray;">
        Location required for delivery (10KM limit)
      </div>

      <div id="kmPill" class="km-pill" style="display:none;"></div>
    </div>

    <div class="card" style="animation-delay: 0.2s;">
      <div class="card-title"><i class='bx bxs-wallet'></i> Payment Method</div>

      <div class="pay-opt active" onclick="selectPay('UPI', event)">
        <div class="radio-circle"></div>
        <div style="flex:1;">
          <b style="font-size:15px;">Pay via UPI (Fast)</b>
          <div style="font-size:12px; color:#666;">Pay now, confirm on WhatsApp</div>
        </div>
        <i class='bx bxs-bank' style="font-size:24px; color:#666;"></i>
      </div>

      <div class="pay-opt" onclick="selectPay('COD', event)">
        <div class="radio-circle"></div>
        <div style="flex:1;">
          <b style="font-size:15px;">Pay on Delivery</b>
          <div style="font-size:12px; color:#666;">Cash / QR Scan on arrival</div>
        </div>
        <i class='bx bxs-truck' style="font-size:24px; color:#666;"></i>
      </div>
    </div>

  </div>

  <div class="bottom-bar">
    <button class="place-btn" id="placeBtn" onclick="processOrder()" disabled>
      Place Order <i class='bx bx-right-arrow-alt'></i>
    </button>
  </div>

  <div class="modal-overlay" id="payModal">
    <div class="modal-card">
      <i class='bx bxs-time-five' style="font-size:60px; color:var(--primary); margin-bottom:15px;"></i>
      <h2 style="margin-bottom:10px;">Completing Payment...</h2>
      <p style="color:#666; font-size:14px; margin-bottom:20px;">
        Please complete the payment on your UPI App. Once done, click the button below to send your order.
      </p>
      <button class="btn" style="background:#25D366; color:white;" onclick="finishWhatsApp()">
        <i class='bx bxl-whatsapp'></i> Payment Done? Send Order
      </button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM",
    authDomain: "sanghx-foods.firebaseapp.com",
    projectId: "sanghx-foods",
    storageBucket: "sanghx-foods.firebasestorage.app",
    messagingSenderId: "491353757911",
    appId: "1:491353757911:web:40752459b5b0049c71f892"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // =========================
  // DELIVERY LIMIT SETTINGS
  // =========================
  const MAX_KM = 10;

  // Sakoli center point
  const SAKOLI_LAT = 21.0819;
  const SAKOLI_LNG = 79.9814;

  // Delivery Fee Rule
  function getDeliveryFeeByKm(km){
    if(km <= 4) return 10;
    if(km > 4 && km <= 7) return 25;
    if(km > 7 && km <= 10) return 40;
    return null;
  }

  // Auto-Fill
  document.getElementById("name").value = localStorage.getItem("uName") || "";
  document.getElementById("mobile").value = localStorage.getItem("uMob") || "";
  document.getElementById("address").value = localStorage.getItem("uAddr") || "";

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let userLoc = "";
  let userDistanceKm = null;
  let paymentMethod = "UPI";

  const placeBtn = document.getElementById("placeBtn");
  const gpsStatus = document.getElementById("gpsStatus");
  const gpsBtn = document.getElementById("gpsBtn");
  const kmPill = document.getElementById("kmPill");
  const deliveryFeeText = document.getElementById("deliveryFeeText");
  const feeRulePill = document.getElementById("feeRulePill");

  if(cart.length === 0) {
    document.body.innerHTML = "<div style='text-align:center; padding:50px;'><h2>Cart Empty üõí</h2><br><a href='index.html' style='color:blue;'>Go Back</a></div>";
  }

  // Fix undefined variantLabel
  cart = cart.map(i => ({
    ...i,
    variantLabel: i.variantLabel || i.variant || "Regular"
  }));

  // Render Items
  let subtotal = cart.reduce((a,b)=>a+(b.price*b.qty),0);

  document.getElementById("orderItems").innerHTML = cart.map(i => `
    <div class="order-item">
      <span>${i.qty}x ${i.name} <small>(${i.variantLabel})</small></span>
      <b>‚Çπ${i.price*i.qty}</b>
    </div>
  `).join("");

  document.getElementById("subtotal").innerText = `‚Çπ${subtotal}`;

  let deliveryFee = 0;
  let total = subtotal + deliveryFee;
  document.getElementById("grandTotal").innerText = `‚Çπ${total}`;

  function toRad(v){ return (v * Math.PI) / 180; }

  function calcDistanceKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function showKm(ok, km){
    kmPill.style.display = "inline-flex";
    kmPill.className = "km-pill " + (ok ? "ok" : "no");
    kmPill.innerHTML = ok
      ? `‚úÖ Delivery Available ‚Ä¢ ${km.toFixed(2)} KM`
      : `‚ùå Out of Range ‚Ä¢ ${km.toFixed(2)} KM`;
  }

  function allowOrder(){
    placeBtn.disabled = false;
    gpsStatus.innerText = `‚úÖ Location locked. Delivery available within ${MAX_KM}KM`;
    gpsStatus.style.color = "green";
  }

  function blockOrder(){
    placeBtn.disabled = true;
    gpsStatus.innerText = `‚ùå We deliver only within ${MAX_KM}KM of Sakoli`;
    gpsStatus.style.color = "red";
  }

  function updateBillAfterGPS(){
    if(userDistanceKm === null){
      deliveryFeeText.innerText = "Attach GPS";
      document.getElementById("grandTotal").innerText = `‚Çπ${subtotal}`;
      return;
    }

    if(userDistanceKm > MAX_KM){
      deliveryFeeText.innerText = "Out of Range";
      document.getElementById("grandTotal").innerText = `‚Çπ${subtotal}`;
      return;
    }

    deliveryFee = getDeliveryFeeByKm(userDistanceKm);
    if(deliveryFee === null){
      deliveryFeeText.innerText = "Out of Range";
      document.getElementById("grandTotal").innerText = `‚Çπ${subtotal}`;
      return;
    }

    total = subtotal + deliveryFee;
    deliveryFeeText.innerText = `‚Çπ${deliveryFee}`;
    document.getElementById("grandTotal").innerText = `‚Çπ${total}`;

    feeRulePill.style.display = "inline-flex";
    feeRulePill.innerHTML = `üöö Fee Rule: 0-4km ‚Çπ10 ‚Ä¢ 4-7km ‚Çπ25 ‚Ä¢ 7-10km ‚Çπ40`;
  }

  window.selectPay = (mode, ev) => {
    paymentMethod = mode;
    document.querySelectorAll(".pay-opt").forEach(el => el.classList.remove("active"));
    ev.currentTarget.classList.add("active");
  };

  window.getLocation = () => {
    gpsBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Detecting...";
    gpsBtn.classList.remove("active");

    if (!navigator.geolocation) {
      alert("GPS not supported.");
      gpsBtn.innerHTML = "<i class='bx bxs-map'></i> Use Current Location";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        userLoc = `https://www.google.com/maps?q=${lat},${lng}`;
        userDistanceKm = calcDistanceKm(lat, lng, SAKOLI_LAT, SAKOLI_LNG);

        gpsBtn.innerHTML = "<i class='bx bxs-check-circle'></i> Location Attached";
        gpsBtn.classList.add("active");

        if(userDistanceKm <= MAX_KM){
          allowOrder();
          showKm(true, userDistanceKm);
        } else {
          blockOrder();
          showKm(false, userDistanceKm);
        }

        updateBillAfterGPS();
      },
      () => {
        gpsBtn.innerHTML = "‚ùå Permission Denied";
        blockOrder();
        gpsStatus.innerText = "‚ùå Location required (Allow GPS)";
        gpsStatus.style.color = "red";
        alert("Please allow location access for delivery.");
        updateBillAfterGPS();
      },
      { enableHighAccuracy: true, timeout: 12000 }
    );
  };

  window.processOrder = async () => {
    const n = document.getElementById("name").value.trim();
    const m = document.getElementById("mobile").value.trim();
    const a = document.getElementById("address").value.trim();

    if(!n || !m || !a) return alert("Please fill all details!");
    if(!userLoc) return alert("Please attach your current location first!");
    if(userDistanceKm === null) return alert("Location check failed. Try again.");
    if(userDistanceKm > MAX_KM){
      alert(`Sorry! We deliver only within ${MAX_KM} KM of Sakoli.\nYou are ${userDistanceKm.toFixed(2)} KM away.`);
      return;
    }

    deliveryFee = getDeliveryFeeByKm(userDistanceKm);
    if(deliveryFee === null){
      alert("Delivery not available for your distance.");
      return;
    }

    total = subtotal + deliveryFee;

    localStorage.setItem("uName", n);
    localStorage.setItem("uMob", m);
    localStorage.setItem("uAddr", a);

    placeBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Processing...";
    placeBtn.disabled = true;

    try {
      await addDoc(collection(db, "orders"), {
        customer: {
          name: n,
          mobile: m,
          address: a,
          location: userLoc,
          distanceKm: Number(userDistanceKm.toFixed(2))
        },
        items: cart,
        bill: { subtotal, delivery: deliveryFee, total },
        payment: paymentMethod,
        status: "Pending",
        timestamp: serverTimestamp()
      });

      if(paymentMethod === "UPI") {
        const upiID = "samyaksangode0-2@okicici"; // ‚úÖ NEW UPI ID
        const note = `Order-${n}`;
        const upiLink = `upi://pay?pa=${upiID}&pn=SANGHX&am=${total}&tn=${note}&cu=INR`;

        window.location.href = upiLink;
        document.getElementById("payModal").classList.add("show");
      } else {
        finishWhatsApp();
      }

    } catch(e) {
      alert("Error placing order: " + e.message);
      placeBtn.disabled = false;
      placeBtn.innerHTML = "Place Order";
    }
  };

  window.finishWhatsApp = () => {
    if(userDistanceKm === null || userDistanceKm > MAX_KM){
      alert(`Delivery not available. Only within ${MAX_KM} KM of Sakoli.`);
      return;
    }

    deliveryFee = getDeliveryFeeByKm(userDistanceKm);
    if(deliveryFee === null){
      alert("Delivery not available for your distance.");
      return;
    }

    total = subtotal + deliveryFee;

    const n = localStorage.getItem("uName");
    const m = localStorage.getItem("uMob");
    const a = localStorage.getItem("uAddr");

    const itemsList = cart.map(i => `‚ñ™ ${i.qty} x ${i.name} (${i.variantLabel})`).join("%0a");

    const msg =
      `*NEW ORDER ALERT* üî•%0a%0a` +
      `üë§ *${n}* (${m})%0a` +
      `üè† ${a}%0a%0a` +
      `üìç Distance: *${userDistanceKm.toFixed(2)} KM* (Sakoli)%0a` +
      `üó∫ Map: ${userLoc}%0a%0a` +
      `*ORDER:*%0a${itemsList}%0a%0a` +
      `üßæ Subtotal: ‚Çπ${subtotal}%0a` +
      `üöö Delivery: ‚Çπ${deliveryFee}%0a` +
      `üí∞ *Total: ‚Çπ${total}* (${paymentMethod})`;

    localStorage.removeItem("cart");
    window.location.href = `https://wa.me/919322586177?text=${msg}`;
  };
</script>

</body>
</html>
