<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SANGHX ‚Ä¢ Customer</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<style>
  :root{
    --dark:#0b0b0f;
    --bg:#f4f5f9;
    --primary:#ff4b3a;
    --white:#fff;
    --shadow: 0 14px 40px rgba(0,0,0,0.10);
    --glass: rgba(255,255,255,0.85);
    --glass-border: 1px solid rgba(255,255,255,0.55);

    --saffron:#ff7a00;
    --green:#00c06a;
    --blue:#1b55ff;
  }

  *{margin:0;padding:0;box-sizing:border-box;font-family:'Outfit',sans-serif;-webkit-tap-highlight-color:transparent}
  body{
    background: var(--bg);
    color:#111;
    padding-bottom:120px;
    overflow-x:hidden;
  }

  /* ===== REPUBLIC DAY FLAG WAVING BACKGROUND ===== */
  .flag-bg{
    position:fixed;
    inset:0;
    z-index:-5;
    overflow:hidden;
    pointer-events:none;
  }
  .flag-bg::before{
    content:"";
    position:absolute;inset:-20%;
    background:
      linear-gradient(180deg, rgba(255,122,0,0.22), rgba(255,122,0,0.22) 33%,
                              rgba(255,255,255,0.18) 33%, rgba(255,255,255,0.18) 66%,
                              rgba(0,192,106,0.22) 66%, rgba(0,192,106,0.22));
    opacity:0.9;
    transform: rotate(-6deg);
    animation: wave 7s ease-in-out infinite alternate;
  }
  .flag-bg::after{
    content:"";
    position:absolute;inset:0;
    background: radial-gradient(circle at 40% 35%, rgba(27,85,255,0.18), transparent 45%),
                radial-gradient(circle at 70% 70%, rgba(0,0,0,0.22), transparent 55%);
    mix-blend-mode:multiply;
    opacity:0.9;
  }
  @keyframes wave{
    0%{transform:translate3d(-1%, -1%,0) rotate(-6deg) skewX(0deg)}
    100%{transform:translate3d(1%, 1%,0) rotate(-6deg) skewX(2deg)}
  }

  .chakra{
    position:fixed;
    width:260px;height:260px;border-radius:50%;
    border:2px dashed rgba(27,85,255,0.25);
    left:50%;top:50%;
    transform:translate(-50%,-50%);
    z-index:-4;
    opacity:0.35;
    animation: spin 18s linear infinite;
  }
  @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

  /* ===== HEADER ===== */
  .header{
    position:sticky;top:0;z-index:100;
    background: rgba(255,255,255,0.72);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-bottom: var(--glass-border);
    padding:14px 18px;
    display:flex;align-items:center;justify-content:space-between;
  }
  .logo{
    font-size:22px;font-weight:900;letter-spacing:-0.5px;
  }
  .logo span{color:var(--primary)}
  .top-icons{
    display:flex;align-items:center;gap:12px;
  }
  .top-icon{
    width:42px;height:42px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    background: rgba(0,0,0,0.06);
    border:1px solid rgba(0,0,0,0.06);
    font-size:22px;color:#111;
    cursor:pointer;
  }

  /* Music button highlight */
  .top-icon.music-on{
    background: rgba(0,192,106,0.12);
    border-color: rgba(0,192,106,0.22);
    color: #0b0b0f;
  }
  .top-icon.music-off{
    background: rgba(255,75,58,0.12);
    border-color: rgba(255,75,58,0.22);
    color: #0b0b0f;
  }

  /* ===== TICKER ===== */
  .ticker-wrap{
    background: rgba(11,11,15,0.92);
    color:#fff;
    height:34px;
    display:flex;align-items:center;
    overflow:hidden;
  }
  .ticker{
    display:inline-block;
    white-space:nowrap;
    animation: scroll 18s linear infinite;
  }
  .ticker span{
    padding:0 28px;
    font-size:12px;
    font-weight:800;
    letter-spacing:0.5px;
    text-transform:uppercase;
  }
  @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  .container{padding:18px;max-width:650px;margin:0 auto}

  /* ===== HERO ===== */
  .hero{
    position:relative;
    width:100%;
    height:190px;
    border-radius:26px;
    overflow:hidden;
    box-shadow: var(--shadow);
    margin-bottom:16px;
    border: 1px solid rgba(255,255,255,0.65);
  }
  .hero img{
    width:100%;height:100%;object-fit:cover;
    transform: scale(1.02);
    animation: zoom 10s infinite alternate;
    transition: opacity .35s ease;
  }
  @keyframes zoom{from{transform:scale(1)}to{transform:scale(1.1)}}
  .hero::before{
    content:"";
    position:absolute;inset:0;
    background: linear-gradient(to top, rgba(0,0,0,0.78), rgba(0,0,0,0.05));
    z-index:1;
  }
  .hero-text{
    position:absolute;left:18px;bottom:16px;
    z-index:2;color:#fff;
  }
  .hero-text h2{
    font-size:28px;font-weight:900;line-height:1;
  }
  .hero-text p{
    margin-top:6px;font-size:12px;color:rgba(255,255,255,0.85);font-weight:700;
  }
  .badge26{
    position:absolute;right:14px;top:14px;
    z-index:2;
    padding:10px 12px;
    border-radius:999px;
    background: rgba(255,255,255,0.18);
    border:1px solid rgba(255,255,255,0.22);
    color:#fff;
    font-weight:900;
    font-size:11px;
    backdrop-filter: blur(10px);
  }

  /* ===== SEARCH ===== */
  .search-wrap{position:relative;margin:12px 0 12px}
  .search{
    width:100%;
    padding:14px 16px 14px 46px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.75);
    background: rgba(255,255,255,0.82);
    box-shadow: var(--shadow);
    outline:none;
    font-size:15px;
    font-weight:700;
  }
  .search:focus{
    border-color: rgba(255,75,58,0.45);
    box-shadow: 0 16px 40px rgba(255,75,58,0.12);
  }
  .sicon{
    position:absolute;left:14px;top:50%;
    transform:translateY(-50%);
    font-size:20px;color:#666;
  }

  /* ===== CHIPS ===== */
  .chips{
    display:flex;gap:10px;
    overflow-x:auto;
    padding-bottom:6px;
    scrollbar-width:none;
    margin-bottom:14px;
  }
  .chip{
    padding:10px 16px;
    border-radius:999px;
    background: rgba(255,255,255,0.78);
    border:1px solid rgba(255,255,255,0.75);
    font-size:13px;
    font-weight:900;
    color:#444;
    white-space:nowrap;
    cursor:pointer;
    transition:.18s;
  }
  .chip.active{
    background: rgba(11,11,15,0.92);
    color:#fff;
    border-color: rgba(11,11,15,0.92);
    box-shadow: 0 12px 30px rgba(0,0,0,0.18);
  }

  /* ===== STORE SECTION ===== */
  .shop-section{margin-bottom:26px;animation: fadeInUp .45s ease}
  .shop-header{
    display:flex;align-items:center;justify-content:space-between;
    margin-bottom:12px;padding:0 4px;
  }
  .shop-name{font-size:18px;font-weight:900}
  .status{
    font-size:10px;
    padding:6px 12px;
    border-radius:999px;
    font-weight:900;
    color:#fff;
    text-transform:uppercase;
  }
  .status.online{background:#00b894;box-shadow:0 8px 20px rgba(0,184,148,0.28)}
  .status.offline{background:#ff7675;opacity:0.9}

  .h-scroll{
    display:flex;gap:14px;
    overflow-x:auto;
    padding:5px 5px 20px;
    scrollbar-width:none;
  }

  /* ===== ITEM CARD ===== */
  .card{
    min-width:215px;
    background: rgba(255,255,255,0.88);
    border:1px solid rgba(255,255,255,0.85);
    border-radius:26px;
    padding:10px;
    box-shadow: 0 16px 40px rgba(0,0,0,0.08);
    position:relative;
    transition:.18s;
    overflow:hidden;
  }
  .card::before{
    content:"";
    position:absolute;inset:-2px;
    background: conic-gradient(from 180deg,
      rgba(255,122,0,0.35),
      rgba(255,255,255,0.20),
      rgba(0,192,106,0.35),
      rgba(27,85,255,0.18),
      rgba(255,122,0,0.35)
    );
    filter: blur(18px);
    opacity:0.45;
    z-index:-1;
    animation: glowSpin 8s linear infinite;
  }
  @keyframes glowSpin{to{transform:rotate(360deg)}}

  .card:active{transform:scale(0.97)}
  .card.offline{filter:grayscale(1);opacity:0.65;pointer-events:none}

  .card img{
    width:100%;height:132px;
    object-fit:cover;
    border-radius:18px;
    background:#eee;
    margin-bottom:10px;
  }
  .card-title{
    font-size:15px;
    font-weight:900;
    margin-bottom:6px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .variant-select{
    width:100%;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.7);
    outline:none;
    font-size:12px;
    font-weight:800;
    margin-bottom:10px;
  }

  .card-footer{display:flex;align-items:center;justify-content:space-between}
  .price{font-size:17px;font-weight:900;color:#111}
  .add-btn{
    width:40px;height:40px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    color:#fff;
    font-size:20px;
    background: rgba(11,11,15,0.92);
    box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    transition:.18s;
    position:relative;
    overflow:hidden;
  }
  .add-btn::before{
    content:"";
    position:absolute;inset:0;
    background: linear-gradient(120deg, transparent, rgba(255,255,255,0.5), transparent);
    transform:translateX(-120%);
    animation: shine2 2.4s infinite;
    opacity:0.7;
  }
  @keyframes shine2{
    0%{transform:translateX(-120%)}
    45%{transform:translateX(120%)}
    100%{transform:translateX(120%)}
  }
  .add-btn:active{transform:scale(0.85);background: var(--primary)}

  /* ===== FLOATING BUTTONS ===== */
  .fab-cart{
    position:fixed;bottom:95px;right:18px;
    background: rgba(11,11,15,0.92);
    color:#fff;
    padding:14px 22px;
    border-radius:999px;
    font-weight:900;
    display:flex;align-items:center;gap:10px;
    box-shadow: 0 18px 45px rgba(0,0,0,0.30);
    z-index:90;
    cursor:pointer;
    transform:translateY(120px);
    opacity:0;
    transition:.3s;
  }
  .fab-cart.visible{transform:translateY(0);opacity:1}

  .fab-ai{
    position:fixed;bottom:24px;right:18px;
    width:66px;height:66px;border-radius:50%;
    border:none;cursor:pointer;
    color:#fff;font-size:30px;
    background: conic-gradient(from 180deg, var(--saffron), #fff, var(--green), var(--blue), var(--saffron));
    box-shadow: 0 18px 45px rgba(255,75,58,0.28);
    z-index:95;
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}

  /* ===== MODALS ===== */
  .modal-overlay{
    position:fixed;inset:0;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(7px);
    z-index:200;
    display:none;
    align-items:flex-end;
    opacity:0;
    transition:opacity .3s;
  }
  .modal-overlay.show{display:flex;opacity:1}
  .modal-card{
    width:100%;
    background: rgba(255,255,255,0.96);
    border-radius:30px 30px 0 0;
    padding:22px;
    box-shadow: 0 -14px 60px rgba(0,0,0,0.20);
    transform:translateY(110%);
    transition: transform .3s cubic-bezier(.2,.8,.2,1);
    max-height:85vh;
    display:flex;flex-direction:column;
  }
  .modal-overlay.show .modal-card{transform:translateY(0)}

  .ai-card{
    background: rgba(255,255,255,0.97);
  }
  .ai-bubble{
    background: rgba(11,11,15,0.06);
    border:1px solid rgba(0,0,0,0.06);
    padding:16px;
    border-radius:18px 18px 18px 6px;
    margin:14px 0;
    font-size:15px;
    font-weight:700;
    line-height:1.5;
    color:#222;
  }

  .input-group{display:flex;gap:10px;margin-top:8px}
  .input-group input{
    flex:1;
    padding:14px 16px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,0.12);
    outline:none;
    font-size:15px;
    font-weight:800;
    background: rgba(255,255,255,0.9);
  }
  .send-btn{
    width:52px;border-radius:14px;border:none;
    background: rgba(11,11,15,0.92);
    color:#fff;font-size:20px;
    cursor:pointer;
  }

  /* cart */
  .cart-list{overflow-y:auto;flex:1;margin-bottom:14px}
  .cart-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.06);
  }
  .qty-ctrl{
    display:flex;align-items:center;gap:12px;
    background: rgba(11,11,15,0.06);
    padding:7px 12px;
    border-radius:14px;
    font-weight:900;
  }

  .bill-box{
    background: rgba(11,11,15,0.04);
    border:1px dashed rgba(0,0,0,0.18);
    padding:14px;border-radius:18px;margin-bottom:12px;
  }
  .bill-row{display:flex;justify-content:space-between;font-size:14px;color:#555;font-weight:800;margin-bottom:6px}
  .bill-total{display:flex;justify-content:space-between;font-size:18px;font-weight:900;margin-top:10px;color:#111}

  .checkout-btn{
    width:100%;
    padding:16px;
    border:none;
    border-radius:18px;
    background: linear-gradient(135deg, var(--saffron), #fff, var(--green));
    color:#0b0b0f;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
    box-shadow: 0 16px 35px rgba(0,0,0,0.15);
  }
  .checkout-btn:active{transform:scale(0.98)}

  /* toast + spark */
  .toast{
    position:fixed;top:95px;left:50%;
    transform:translateX(-50%) scale(0.92);
    background: rgba(11,11,15,0.92);
    color:#fff;
    padding:12px 18px;
    border-radius:999px;
    font-size:13px;
    font-weight:900;
    opacity:0;
    pointer-events:none;
    transition:.25s cubic-bezier(.175,.885,.32,1.275);
    z-index:300;
    display:flex;align-items:center;gap:8px;
    box-shadow: 0 16px 40px rgba(0,0,0,0.22);
  }
  .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
  .spark{
    position:fixed;pointer-events:none;
    width:22px;height:22px;border-radius:50%;
    background: radial-gradient(circle, #ffd700, transparent);
    transform:scale(0);
    z-index:300;
  }
  .spark.active{animation: pop .6s ease-out}
  @keyframes pop{0%{transform:scale(0);opacity:1}50%{opacity:1}100%{transform:scale(4.2);opacity:0}}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

  /* small helper */
  .tiny-note{
    font-size:11px;
    color:#666;
    font-weight:800;
    margin-top:8px;
    text-align:center;
  }
</style>
</head>

<body>
  <div class="flag-bg"></div>
  <div class="chakra"></div>

  <!-- üîä BACKGROUND MUSIC -->
  <audio id="bgMusic" src="republic.mpeg" preload="auto" loop playsinline></audio>

  <div class="header">
    <div class="logo">SAN<span>GHX</span></div>
    <div class="top-icons">
      <a class="top-icon" href="https://wa.me/918087762813" target="_blank" style="text-decoration:none;">
        <i class='bx bxl-whatsapp'></i>
      </a>

      <!-- Music Toggle -->
      <div class="top-icon music-on" id="musicBtn" title="Music">
        <i class='bx bxs-volume-full'></i>
      </div>

      <div class="top-icon" id="themeBtn" title="Republic Mode">
        <i class='bx bxs-flag-alt'></i>
      </div>
    </div>
  </div>

  <div class="ticker-wrap">
    <div class="ticker">
      <span>üáÆüá≥ Republic Day Special ‚Ä¢ SANGHX = fast ‚Ä¢ local ‚Ä¢ savage</span>
      <span>üçî ‡§≠‡§æ‡§µ‡§æ ‡§Ü‡§ú ‡§ï‡§æ‡§Ø ‡§ñ‡§æ‡§Ø‡§ö‡§Ç? BRO AI ‡§≤‡§æ ‡§µ‡§ø‡§ö‡§æ‡§∞</span>
      <span>‚ö° Open stores first ‚Ä¢ closed stores bottom</span>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <img id="heroImg" src="2.png" alt="hero">
      <div class="badge26">26 JAN üáÆüá≥</div>
      <div class="hero-text">
        <h2>Tricolor<br>Deals üî•</h2>
        <p>Crazy offers ‚Ä¢ Fast delivery ‚Ä¢ Sakoli power</p>
      </div>
    </div>

    <div class="search-wrap">
      <i class='bx bx-search sicon'></i>
      <input class="search" id="searchInput" placeholder="Search biryani, pizza, rolls...">
    </div>

    <div class="chips" id="categoryChips">
      <div class="chip active">All</div>
    </div>

    <div id="storesWrap"></div>

    <div class="tiny-note">Republic Day vibe music auto-start (first tap fallback) üáÆüá≥üéµ</div>
  </div>

  <div class="fab-cart" id="miniCartBtn">
    <i class='bx bxs-shopping-bag' style="font-size:20px;"></i>
    <span id="cartCount">0</span>
  </div>

  <button class="fab-ai" id="aiBtn"><i class='bx bx-bot'></i></button>

  <!-- CART MODAL -->
  <div class="modal-overlay" id="cartModalBg">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
        <h2 style="font-weight:900;">Your Cart üõí</h2>
        <i class='bx bx-x' style="font-size:28px; padding:8px; background:rgba(0,0,0,0.06); border-radius:50%; cursor:pointer;" id="closeCartBtn"></i>
      </div>

      <div class="cart-list" id="cartItems"></div>

      <div class="bill-box">
        <div class="bill-row"><span>Subtotal</span> <span id="subtotal">‚Çπ0</span></div>
        <div class="bill-row"><span>Delivery</span> <span style="font-weight:900;color:#111;">Calculated at checkout</span></div>
        <div class="bill-total"><span>Total</span> <span id="total">‚Çπ0</span></div>
      </div>

      <button class="checkout-btn" id="checkoutBtn">Go To Checkout üöÄ</button>
    </div>
  </div>

  <!-- AI MODAL -->
  <div class="modal-overlay" id="aiPanelBg">
    <div class="modal-card ai-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:12px;">
          <div style="width:45px; height:45px; background:rgba(11,11,15,0.92); color:white; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:24px;">
            <i class='bx bx-bot'></i>
          </div>
          <div>
            <b style="display:block; font-size:16px;">BRO AI V3</b>
            <small style="color:var(--primary); font-weight:900; font-size:11px;">Marathi + Emotion üáÆüá≥</small>
          </div>
        </div>
        <i class='bx bx-x' id="aiCloseBtn" style="font-size:28px; padding:5px; cursor:pointer;"></i>
      </div>

      <div class="ai-bubble" id="aiLine">‡§≠‡§æ‡§µ‡§æ‚Ä¶ ‡§Æ‡•Ä ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡•á! ‚Äú‡§≠‡•Ç‡§ï ‡§≤‡§æ‡§ó‡§≤‡•Ä‚Äù ‡§Ö‡§∏‡§Ç ‡§ü‡§æ‡§à‡§™ ‡§ï‡§∞ üòÑ</div>

      <div class="input-group">
        <input id="aiInput" placeholder="Ask me (e.g. Best combo?)...">
        <button class="send-btn" id="aiSendBtn"><i class='bx bxs-send'></i></button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <i class='bx bxs-check-circle' style="color:#2ed573; font-size:18px;"></i>
    <span>Added to cart</span>
  </div>
  <div id="spark" class="spark"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM",
    projectId: "sanghx-foods"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let STORES = [];
  let MENU = [];
  let ACTIVE_CATEGORY = "All";
  let SEARCH = "";

  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  const els = {
    stores: document.getElementById("storesWrap"),
    chips: document.getElementById("categoryChips"),
    search: document.getElementById("searchInput"),
    miniCart: document.getElementById("miniCartBtn"),
    cartModal: document.getElementById("cartModalBg"),
    cartItems: document.getElementById("cartItems"),
    aiModal: document.getElementById("aiPanelBg"),
    aiLine: document.getElementById("aiLine"),
    aiInput: document.getElementById("aiInput"),
    toast: document.getElementById("toast"),
    spark: document.getElementById("spark"),
    music: document.getElementById("bgMusic"),
    musicBtn: document.getElementById("musicBtn"),
  };

  // =========================
  // üîä MUSIC ENGINE (AUTO PLAY)
  // =========================
  let musicEnabled = (localStorage.getItem("musicEnabled") ?? "1") === "1";

  function updateMusicBtn(){
    if(musicEnabled){
      els.musicBtn.classList.add("music-on");
      els.musicBtn.classList.remove("music-off");
      els.musicBtn.innerHTML = "<i class='bx bxs-volume-full'></i>";
    }else{
      els.musicBtn.classList.add("music-off");
      els.musicBtn.classList.remove("music-on");
      els.musicBtn.innerHTML = "<i class='bx bxs-volume-mute'></i>";
    }
  }

  async function tryPlayMusic(){
    if(!musicEnabled) return;
    try{
      els.music.volume = 0.22;
      els.music.muted = false;
      await els.music.play();
    }catch(err){
      // autoplay blocked by browser (normal)
    }
  }

  function stopMusic(){
    els.music.pause();
  }

  els.musicBtn.addEventListener("click", async ()=>{
    musicEnabled = !musicEnabled;
    localStorage.setItem("musicEnabled", musicEnabled ? "1" : "0");
    updateMusicBtn();

    if(musicEnabled){
      await tryPlayMusic();
      showToast("Music ON üáÆüá≥");
    }else{
      stopMusic();
      showToast("Music OFF üîá");
    }
  });

  // If autoplay blocked, start on FIRST TAP ANYWHERE
  function oneTapStart(){
    if(musicEnabled) tryPlayMusic();
    window.removeEventListener("pointerdown", oneTapStart);
    window.removeEventListener("touchstart", oneTapStart);
    window.removeEventListener("click", oneTapStart);
  }
  window.addEventListener("pointerdown", oneTapStart, { once:true });
  window.addEventListener("touchstart", oneTapStart, { once:true });
  window.addEventListener("click", oneTapStart, { once:true });

  updateMusicBtn();
  tryPlayMusic();

  // =========================
  // HERO AUTO SLIDER
  // =========================
  const heroImages = ["2.png", "newp.jpeg", "new.png"];
  let heroIndex = 0;
  const heroImgEl = document.getElementById("heroImg");

  setInterval(() => {
    heroIndex = (heroIndex + 1) % heroImages.length;
    heroImgEl.style.opacity = "0";
    setTimeout(() => {
      heroImgEl.src = heroImages[heroIndex];
      heroImgEl.style.opacity = "1";
    }, 280);
  }, 3000);

  // =========================
  // üîä VOICE ENGINE (Marathi voice priority + emoji remove)
  // =========================
  let selectedVoice = null;

  function loadVoices() {
    const voices = window.speechSynthesis.getVoices();
    const pick =
      voices.find(v => v.lang && v.lang.toLowerCase().includes("mr-in")) ||
      voices.find(v => v.lang && v.lang.toLowerCase().includes("hi-in")) ||
      voices.find(v => v.lang && v.lang.toLowerCase().includes("en-in")) ||
      voices[0];
    selectedVoice = pick || null;
  }

  if (window.speechSynthesis.onvoiceschanged !== undefined) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }
  loadVoices();

  function cleanSpeakText(text){
    return String(text||"")
      .replace(/[\u{1F300}-\u{1FAFF}]/gu, "")  // emojis
      .replace(/[\u{2600}-\u{26FF}]/gu, "")    // misc symbols
      .replace(/üáÆüá≥/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function speak(text) {
    if (!('speechSynthesis' in window)) return;
    const clean = cleanSpeakText(text);
    if(!clean) return;

    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(clean);
    if(selectedVoice) u.voice = selectedVoice;

    u.lang = (selectedVoice && selectedVoice.lang) ? selectedVoice.lang : "mr-IN";
    u.rate = 0.95;  // ‡§•‡•ã‡§°‡§º‡§æ slow = Marathi feel better
    u.pitch = 1.0;

    window.speechSynthesis.speak(u);
  }

  function safe(str){ return String(str||"").replace(/</g,"&lt;"); }

  // =========================
  // CATEGORY CHIPS
  // =========================
  function renderCategoryChips(){
    const cats = ["All", ...new Set(MENU.map(m => m.category).filter(Boolean))];
    els.chips.innerHTML = cats.map(c =>
      `<div class="chip ${ACTIVE_CATEGORY===c?'active':''}" onclick="setCat('${c}')">${c}</div>`
    ).join("");
  }
  window.setCat = (c)=>{ ACTIVE_CATEGORY=c; renderCategoryChips(); renderStores(); };

  // =========================
  // STORES RENDER (online first)
  // =========================
  function renderStores(){
    els.stores.innerHTML = "";

    if(STORES.length===0){
      els.stores.innerHTML = "<div style='text-align:center;padding:40px;color:#666;font-weight:900;'>Loading Stores...</div>";
      return;
    }

    const sortedStores = [...STORES].sort((a,b)=>{
      const ao = a.isOnline ? 1 : 0;
      const bo = b.isOnline ? 1 : 0;
      return bo - ao;
    });

    sortedStores.forEach(store=>{
      const items = MENU.filter(m =>
        (m.storeName === store.name) &&
        (ACTIVE_CATEGORY==="All" || m.category===ACTIVE_CATEGORY) &&
        (m.name.toLowerCase().includes(SEARCH) || store.name.toLowerCase().includes(SEARCH))
      );

      if(items.length===0 && SEARCH) return;

      const section = document.createElement("div");
      section.className="shop-section";
      section.innerHTML = `
        <div class="shop-header">
          <div class="shop-name">${safe(store.name)}</div>
          <div class="status ${store.isOnline?'online':'offline'}">
            ${store.isOnline ? 'Open Now' : 'Closed'}
          </div>
        </div>
        <div class="h-scroll"></div>
      `;

      const list = section.querySelector(".h-scroll");
      if(items.length===0){
        list.innerHTML = "<div style='font-size:13px;color:#666;padding:10px;font-weight:800;'>No items found here</div>";
      }

      items.forEach(item=>{
        const variants = item.variants || [{label:"Regular", price:item.price}];

        const div = document.createElement("div");
        div.className = `card ${store.isOnline?'':'offline'}`;

        const opts = variants.map((v,i)=>`<option value="${i}">${v.label} - ‚Çπ${v.price}</option>`).join("");

        div.innerHTML = `
          <img src="${item.img}" onerror="this.src='https://via.placeholder.com/150'">
          <div style="padding:0 5px 5px;">
            <div class="card-title">${safe(item.name)}</div>
            <select class="variant-select">${opts}</select>
            <div class="card-footer">
              <div class="price">‚Çπ<span class="p-val">${variants[0].price}</span></div>
              <button class="add-btn"><i class='bx bx-plus'></i></button>
            </div>
          </div>
        `;

        const sel = div.querySelector(".variant-select");
        const pVal = div.querySelector(".p-val");
        sel.onchange = ()=> pVal.innerText = variants[sel.value].price;

        div.querySelector(".add-btn").onclick = (e)=>{
          if(!store.isOnline) return;
          const v = variants[sel.value];
          addToCart(item, store.name, v.label, v.price);
          animateSpark(e.clientX, e.clientY);
        };

        list.appendChild(div);
      });

      els.stores.appendChild(section);
    });
  }

  // =========================
  // CART
  // =========================
  function addToCart(item, storeName, variant, price){
    const key = `${item.id}-${variant}`;
    const exist = cart.find(x=>x.key===key);
    if(exist) exist.qty++;
    else cart.push({ key, id:item.id, name:item.name, storeName, variantLabel:variant, price, qty:1 });

    saveCart();
    speak(`${item.name} add ‡§ù‡§æ‡§≤‡§Ç`);
    showToast(`Added ${item.name}`);
  }

  function updateQty(key, delta){
    const i = cart.find(x=>x.key===key);
    if(!i) return;
    i.qty += delta;
    if(i.qty<=0) cart = cart.filter(x=>x.key!==key);
    saveCart();
  }
  window.upd = (key, delta)=> updateQty(key, delta);

  function saveCart(){
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  function renderCart(){
    const totalQty = cart.reduce((a,b)=>a+b.qty,0);
    els.miniCart.classList.toggle("visible", totalQty>0);
    document.getElementById("cartCount").innerText = totalQty;

    els.cartItems.innerHTML = cart.length ? cart.map(i=>`
      <div class="cart-item">
        <div>
          <div style="font-weight:900;font-size:15px;">${safe(i.name)}</div>
          <div style="font-size:12px;color:#666;font-weight:800;">${safe(i.variantLabel)} ‚Ä¢ ‚Çπ${i.price}</div>
        </div>
        <div class="qty-ctrl">
          <i class='bx bx-minus' onclick="window.upd('${i.key}',-1)" style="cursor:pointer"></i>
          <span>${i.qty}</span>
          <i class='bx bx-plus' onclick="window.upd('${i.key}',1)" style="cursor:pointer"></i>
        </div>
      </div>
    `).join("") : `<div style="text-align:center;color:#666;font-weight:900;padding:20px;">Cart is empty üõí</div>`;

    const subtotal = cart.reduce((t,i)=>t+(i.price*i.qty),0);
    document.getElementById("subtotal").innerText = "‚Çπ" + subtotal;
    document.getElementById("total").innerText = "‚Çπ" + subtotal;
  }

  // =========================
  // TOAST + SPARK
  // =========================
  function showToast(msg){
    els.toast.querySelector("span").innerText = msg;
    els.toast.classList.add("show");
    setTimeout(()=>els.toast.classList.remove("show"), 1200);
  }
  function animateSpark(x,y){
    els.spark.style.left = (x-10)+"px";
    els.spark.style.top = (y-10)+"px";
    els.spark.classList.remove("active");
    void els.spark.offsetWidth;
    els.spark.classList.add("active");
  }

  // =========================
  // MODALS
  // =========================
  els.miniCart.onclick = ()=> els.cartModal.classList.add("show");
  document.getElementById("closeCartBtn").onclick = ()=> els.cartModal.classList.remove("show");

  document.getElementById("checkoutBtn").onclick = ()=>{
    if(cart.length===0){ showToast("Cart empty"); return; }
    location.href="checkout.html";
  };

  document.getElementById("aiBtn").onclick = ()=>{
    els.aiModal.classList.add("show");
    setTimeout(()=> els.aiInput.focus(), 150);
  };
  document.getElementById("aiCloseBtn").onclick = ()=> els.aiModal.classList.remove("show");

  // =========================
  // SEARCH
  // =========================
  els.search.addEventListener("input", ()=>{
    SEARCH = (els.search.value || "").toLowerCase();
    renderStores();
  });

  // =========================
  // BRO AI V3 (clean Marathi replies)
  // =========================
  function broReply(q){
    const text = (q||"").toLowerCase();

    if(!text.trim()){
      return "‡§≠‡§æ‡§µ‡§æ ‡§ï‡§æ‡§π‡•Ä‡§§‡§∞‡•Ä ‡§ü‡§æ‡§à‡§™ ‡§ï‡§∞‚Ä¶ ‡§Æ‡•Ä mind read ‡§®‡§æ‡§π‡•Ä ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§!";
    }
    if(text.includes("bhook") || text.includes("‡§≠‡•Ç‡§ï") || text.includes("hungry")){
      return "‡§≠‡•Ç‡§ï ‡§≤‡§æ‡§ó‡§≤‡•Ä ‡§®‡§æ? ‡§Æ‡§ó heavy combo ‡§ò‡•á: ‡§¨‡§ø‡§∞‡•ç‡§Ø‡§æ‡§£‡•Ä + ‡§ï‡•ã‡§≤‡•ç‡§° ‡§°‡•ç‡§∞‡§ø‡§Ç‡§ï‚Ä¶ ‡§Ü‡§£‡§ø ‡§∂‡•á‡§µ‡§ü‡•Ä ‡§ó‡•Å‡§≤‡§æ‡§¨‡§ú‡§æ‡§Æ!";
    }
    if(text.includes("cheap") || text.includes("budget") || text.includes("‡§∏‡•ç‡§µ‡§∏‡•ç‡§§")){
      return "Budget tight ‡§Ü‡§π‡•á? ‡§Æ‡§ó ‡§∞‡•ã‡§≤‡•ç‡§∏ / ‡§Æ‡•Ö‡§ó‡•Ä / ‡§´‡•ç‡§∞‡§æ‡§à‡§ú ‡§¨‡•á‡§∏‡•ç‡§ü. ‡§ï‡§Æ‡•Ä ‡§™‡•à‡§∂‡§æ‡§§ full satisfaction!";
    }
    if(text.includes("spicy") || text.includes("tikka") || text.includes("‡§§‡§ø‡§ñ‡§ü")){
      return "‡§§‡§ø‡§ñ‡§ü ‡§™‡§æ‡§π‡§ø‡§ú‡•á? ‡§Æ‡§ó spicy ‡§ö‡§ø‡§ï‡§® ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§™‡§®‡•Ä‡§∞ ‡§ü‡§ø‡§ï‡•ç‡§ï‡§æ. ‡§™‡§£ ‡§™‡§æ‡§£‡•Ä ‡§ú‡§µ‡§≥ ‡§†‡•á‡§µ!";
    }
    if(text.includes("veg")){
      return "Veg mode ON. ‡§™‡§®‡•Ä‡§∞ + ‡§ö‡•Ä‡§ú ‡§ï‡•â‡§Æ‡•ç‡§¨‡•ã ‡§ò‡•á‚Ä¶ full ‡§Æ‡§ú‡§æ!";
    }
    if(text.includes("best") || text.includes("recommend") || text.includes("‡§∏‡•Å‡§ö‡§µ")){
      return "Best combo: ‡§è‡§ï main dish + ‡§è‡§ï side + ‡§è‡§ï drink. ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡§æ‡§ú‡§æ ‡§µ‡§æ‡§≤‡§æ order!";
    }
    if(text.includes("republic") || text.includes("26") || text.includes("flag")){
      return "26 ‡§ú‡§æ‡§®‡•á‡§µ‡§æ‡§∞‡•Ä special vibe ‡§ö‡§æ‡§≤‡•Ç ‡§Ü‡§π‡•á. ‡§Ü‡§ú order ‡§ï‡§∞‚Ä¶ tricolor energy ready ‡§Ü‡§π‡•á!";
    }
    return "‡§∏‡§Æ‡§ú‡§≤‡§Ç ‡§≠‡§æ‡§µ‡§æ! ‡§∏‡§æ‡§Ç‡§ó ‡§ï‡§æ‡§Ø ‡§ñ‡§æ‡§Ø‡§ö‡§Ç? ‡§Æ‡•Ä ‡§§‡•Å‡§ù‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä combo set ‡§ï‡§∞‡§§‡•ã!";
  }

  function sendAI(){
    const q = els.aiInput.value.trim();
    const ans = broReply(q);
    els.aiLine.innerText = ans;
    speak(ans);
    els.aiInput.value="";
  }
  document.getElementById("aiSendBtn").onclick = sendAI;
  els.aiInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendAI(); });

  // =========================
  // FIRESTORE LISTENERS
  // =========================
  onSnapshot(collection(db, "stores"), (snapshot)=>{
    STORES = [];
    snapshot.forEach(d => STORES.push({ id:d.id, ...d.data() }));
    renderStores();
  });

  onSnapshot(collection(db, "menu"), (snapshot)=>{
    MENU = [];
    snapshot.forEach(doc => MENU.push({ id:doc.id, ...doc.data() }));
    renderCategoryChips();
    renderStores();
  });

  // INIT
  renderCart();

  // AUTO AI GREET once per session
  if(!sessionStorage.getItem("broGreeted")){
    sessionStorage.setItem("broGreeted","1");
    setTimeout(()=>{
      const greet = "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§≠‡§æ‡§µ‡§æ! ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á. ‡§Ü‡§ú ‡§ï‡§æ‡§Ø ‡§ñ‡§æ‡§Ø‡§ö‡§Ç?";
      els.aiLine.innerText = greet;
      speak(greet);
    }, 700);
  }
</script>

</body>
</html>

